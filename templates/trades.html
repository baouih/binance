{% extends 'layout.html' %}

{% block title %}Giao dịch{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2"><i class="fas fa-exchange-alt me-2"></i>Lịch sử giao dịch</h1>
        <div class="btn-toolbar mb-2 mb-md-0">
            <div class="input-group me-2">
                <input type="text" class="form-control" placeholder="Tìm kiếm..." id="trade-search">
                <button class="btn btn-outline-secondary" type="button" id="search-btn">
                    <i class="fas fa-search"></i>
                </button>
            </div>
            <div class="dropdown me-2">
                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="filterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="fas fa-filter me-1"></i>
                    Bộ lọc
                </button>
                <ul class="dropdown-menu" aria-labelledby="filterDropdown">
                    <li><h6 class="dropdown-header">Loại giao dịch</h6></li>
                    <li>
                        <div class="form-check ms-2">
                            <input class="form-check-input" type="checkbox" value="" id="filter-long" checked>
                            <label class="form-check-label" for="filter-long">Long</label>
                        </div>
                    </li>
                    <li>
                        <div class="form-check ms-2">
                            <input class="form-check-input" type="checkbox" value="" id="filter-short" checked>
                            <label class="form-check-label" for="filter-short">Short</label>
                        </div>
                    </li>
                    <li><hr class="dropdown-divider"></li>
                    <li><h6 class="dropdown-header">Kết quả</h6></li>
                    <li>
                        <div class="form-check ms-2">
                            <input class="form-check-input" type="checkbox" value="" id="filter-profit" checked>
                            <label class="form-check-label" for="filter-profit">Lãi</label>
                        </div>
                    </li>
                    <li>
                        <div class="form-check ms-2">
                            <input class="form-check-input" type="checkbox" value="" id="filter-loss" checked>
                            <label class="form-check-label" for="filter-loss">Lỗ</label>
                        </div>
                    </li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="#" id="apply-filters">Áp dụng</a></li>
                </ul>
            </div>
            <div class="btn-group">
                <button type="button" class="btn btn-sm btn-outline-secondary" id="download-csv">
                    <i class="fas fa-download me-1"></i>
                    CSV
                </button>
                <button type="button" class="btn btn-sm btn-outline-secondary" id="download-pdf">
                    <i class="fas fa-file-pdf me-1"></i>
                    PDF
                </button>
            </div>
        </div>
    </div>

    <!-- Trading Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title text-primary">Tổng giao dịch</h5>
                    <h2 class="mb-0">{{ total_trades }}</h2>
                    <div class="d-flex align-items-center mt-2">
                        <div class="d-flex align-items-center me-3">
                            <span class="dot bg-success me-1"></span>
                            <small>{{ winning_trades }} thắng</small>
                        </div>
                        <div class="d-flex align-items-center">
                            <span class="dot bg-danger me-1"></span>
                            <small>{{ losing_trades }} thua</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title text-success">Tỷ lệ thắng</h5>
                    <h2 class="mb-0">{{ win_rate }}%</h2>
                    <div class="progress mt-2" style="height: 8px;">
                        <div class="progress-bar bg-success" role="progressbar" style="width: {{ win_rate }}%" aria-valuenow="{{ win_rate }}" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title text-info">Lợi nhuận gộp</h5>
                    <h2 class="mb-0 {{ 'text-success' if total_profit > 0 else 'text-danger' }}">
                        {{ '$' + total_profit|string if total_profit >= 0 else '-$' + (total_profit|abs)|string }}
                    </h2>
                    <small class="text-muted">Bao gồm phí giao dịch</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title text-warning">Profit Factor</h5>
                    <h2 class="mb-0">{{ profit_factor }}</h2>
                    <small class="text-muted">Tổng lãi / Tổng lỗ</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Trades Distribution Chart -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Phân phối giao dịch</h5>
                    <div class="btn-group btn-group-sm">
                        <button type="button" class="btn btn-outline-secondary active chart-period" data-period="1w">1W</button>
                        <button type="button" class="btn btn-outline-secondary chart-period" data-period="1m">1M</button>
                        <button type="button" class="btn btn-outline-secondary chart-period" data-period="3m">3M</button>
                        <button type="button" class="btn btn-outline-secondary chart-period" data-period="all">Tất cả</button>
                    </div>
                </div>
                <div class="card-body">
                    <canvas id="tradesDistributionChart" height="250"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card shadow-sm">
                <div class="card-header">
                    <h5 class="mb-0">Phân tích giao dịch</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <h6>Theo loại</h6>
                        <div class="progress mb-2" style="height: 20px;">
                            <div class="progress-bar bg-success" role="progressbar" style="width: 65%" aria-valuenow="65" aria-valuemin="0" aria-valuemax="100">Long (65%)</div>
                            <div class="progress-bar bg-danger" role="progressbar" style="width: 35%" aria-valuenow="35" aria-valuemin="0" aria-valuemax="100">Short (35%)</div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <h6>Theo thời gian</h6>
                        <div class="d-flex justify-content-between align-items-center">
                            <canvas id="tradesTimeChart" height="150"></canvas>
                        </div>
                    </div>
                    <div>
                        <h6>Theo cặp tiền</h6>
                        <div class="d-flex justify-content-between align-items-center">
                            <canvas id="tradePairsChart" height="150"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Trade History Table -->
    <div class="card shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Chi tiết giao dịch</h5>
            <div class="form-check form-switch mb-0">
                <input class="form-check-input" type="checkbox" id="auto-refresh-trades" checked>
                <label class="form-check-label" for="auto-refresh-trades">Tự động làm mới</label>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-striped table-hover mb-0" id="trades-table">
                    <thead>
                        <tr>
                            <th><a href="#" class="table-sort" data-sort="id">ID <i class="fas fa-sort"></i></a></th>
                            <th><a href="#" class="table-sort" data-sort="symbol">Cặp <i class="fas fa-sort"></i></a></th>
                            <th><a href="#" class="table-sort" data-sort="type">Loại <i class="fas fa-sort"></i></a></th>
                            <th><a href="#" class="table-sort" data-sort="entry_price">Giá vào <i class="fas fa-sort"></i></a></th>
                            <th><a href="#" class="table-sort" data-sort="exit_price">Giá ra <i class="fas fa-sort"></i></a></th>
                            <th><a href="#" class="table-sort" data-sort="quantity">Số lượng <i class="fas fa-sort"></i></a></th>
                            <th><a href="#" class="table-sort" data-sort="pnl">Lợi nhuận <i class="fas fa-sort"></i></a></th>
                            <th><a href="#" class="table-sort" data-sort="entry_time">Thời gian vào <i class="fas fa-sort"></i></a></th>
                            <th><a href="#" class="table-sort" data-sort="exit_time">Thời gian ra <i class="fas fa-sort"></i></a></th>
                            <th><a href="#" class="table-sort" data-sort="exit_reason">Lý do thoát <i class="fas fa-sort"></i></a></th>
                            <th>Chi tiết</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for trade in trades %}
                        <tr class="{{ 'table-success' if trade.pnl >= 0 else 'table-danger' }}">
                            <td>{{ trade.id }}</td>
                            <td>{{ trade.symbol }}</td>
                            <td>
                                <span class="badge {{ 'bg-success' if trade.type == 'LONG' else 'bg-danger' }}">
                                    {{ trade.type }}
                                </span>
                            </td>
                            <td>${{ trade.entry_price }}</td>
                            <td>${{ trade.exit_price }}</td>
                            <td>{{ trade.quantity }}</td>
                            <td class="{{ 'text-success' if trade.pnl >= 0 else 'text-danger' }}">
                                {{ '$' + trade.pnl|string if trade.pnl >= 0 else '-$' + (trade.pnl|abs)|string }}
                                ({{ trade.pnl_percent }}%)
                            </td>
                            <td>{{ trade.entry_time }}</td>
                            <td>{{ trade.exit_time }}</td>
                            <td>
                                <span class="badge {{ 
                                    'bg-success' if trade.exit_reason == 'take_profit' 
                                    else 'bg-danger' if trade.exit_reason == 'stop_loss'
                                    else 'bg-info' }}">
                                    {{ trade.exit_reason }}
                                </span>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary view-trade-details" data-trade-id="{{ trade.id }}">
                                    <i class="fas fa-info-circle"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        <div class="card-footer">
            <nav aria-label="Page navigation">
                <ul class="pagination justify-content-center mb-0">
                    <li class="page-item disabled">
                        <a class="page-link" href="#" tabindex="-1">Trước</a>
                    </li>
                    <li class="page-item active"><a class="page-link" href="#">1</a></li>
                    <li class="page-item"><a class="page-link" href="#">2</a></li>
                    <li class="page-item"><a class="page-link" href="#">3</a></li>
                    <li class="page-item">
                        <a class="page-link" href="#">Sau</a>
                    </li>
                </ul>
            </nav>
        </div>
    </div>

    <!-- Trade Details Modal -->
    <div class="modal fade" id="tradeDetailsModal" tabindex="-1" aria-labelledby="tradeDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="tradeDetailsModalLabel">Chi tiết giao dịch</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <h6>Thông tin giao dịch</h6>
                                <table class="table table-sm">
                                    <tbody id="trade-details-table">
                                        <tr>
                                            <td>ID</td>
                                            <td id="detail-id">trade10</td>
                                        </tr>
                                        <tr>
                                            <td>Cặp</td>
                                            <td id="detail-symbol">BTCUSDT</td>
                                        </tr>
                                        <tr>
                                            <td>Loại</td>
                                            <td id="detail-type"><span class="badge bg-success">LONG</span></td>
                                        </tr>
                                        <tr>
                                            <td>Giá vào</td>
                                            <td id="detail-entry">$65,000.00</td>
                                        </tr>
                                        <tr>
                                            <td>Giá ra</td>
                                            <td id="detail-exit">$69,000.00</td>
                                        </tr>
                                        <tr>
                                            <td>Số lượng</td>
                                            <td id="detail-quantity">0.1</td>
                                        </tr>
                                        <tr>
                                            <td>Đòn bẩy</td>
                                            <td id="detail-leverage">5x</td>
                                        </tr>
                                        <tr>
                                            <td>Lợi nhuận</td>
                                            <td id="detail-pnl" class="text-success">$400.00 (6.15%)</td>
                                        </tr>
                                        <tr>
                                            <td>Thời gian giao dịch</td>
                                            <td id="detail-duration">10 giờ 45 phút</td>
                                        </tr>
                                        <tr>
                                            <td>Lý do thoát</td>
                                            <td id="detail-reason"><span class="badge bg-success">take_profit</span></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <h6>Biểu đồ giao dịch</h6>
                                <canvas id="tradeChartDetail" height="200"></canvas>
                            </div>
                            <div>
                                <h6>Chỉ báo</h6>
                                <ul class="list-group" id="trade-indicators">
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        RSI
                                        <span class="badge bg-success">32 (Mua)</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        MACD
                                        <span class="badge bg-success">Tín hiệu tăng</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        Bollinger Bands
                                        <span class="badge bg-success">Nến đóng trên band dưới</span>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="button" class="btn btn-primary" id="export-trade-detail">
                        <i class="fas fa-download me-1"></i> Xuất báo cáo
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize Trades Distribution Chart
        const ctx = document.getElementById('tradesDistributionChart').getContext('2d');
        const tradesDistributionChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                datasets: [
                    {
                        label: 'Giao dịch thắng',
                        data: [5, 7, 3, 8, 6, 4, 7, 9, 8, 10, 8, 12],
                        backgroundColor: 'rgba(40, 167, 69, 0.7)',
                        borderColor: 'rgba(40, 167, 69, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Giao dịch thua',
                        data: [3, 2, 4, 2, 3, 3, 2, 3, 4, 2, 3, 4],
                        backgroundColor: 'rgba(220, 53, 69, 0.7)',
                        borderColor: 'rgba(220, 53, 69, 1)',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                scales: {
                    x: {
                        stacked: true,
                    },
                    y: {
                        stacked: true
                    }
                }
            }
        });

        // Time of day chart
        const timeCtx = document.getElementById('tradesTimeChart').getContext('2d');
        new Chart(timeCtx, {
            type: 'doughnut',
            data: {
                labels: ['00-06', '06-12', '12-18', '18-24'],
                datasets: [{
                    data: [10, 35, 30, 25],
                    backgroundColor: [
                        'rgba(108, 117, 125, 0.7)',
                        'rgba(255, 193, 7, 0.7)',
                        'rgba(40, 167, 69, 0.7)',
                        'rgba(13, 110, 253, 0.7)'
                    ],
                    borderColor: [
                        'rgba(108, 117, 125, 1)',
                        'rgba(255, 193, 7, 1)',
                        'rgba(40, 167, 69, 1)',
                        'rgba(13, 110, 253, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'right',
                    }
                }
            }
        });

        // Pairs chart
        const pairsCtx = document.getElementById('tradePairsChart').getContext('2d');
        new Chart(pairsCtx, {
            type: 'pie',
            data: {
                labels: ['BTC', 'ETH', 'BNB', 'SOL', 'Others'],
                datasets: [{
                    data: [45, 25, 10, 15, 5],
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.7)',
                        'rgba(54, 162, 235, 0.7)',
                        'rgba(255, 206, 86, 0.7)',
                        'rgba(75, 192, 192, 0.7)',
                        'rgba(153, 102, 255, 0.7)'
                    ],
                    borderColor: [
                        'rgba(255, 99, 132, 1)',
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 206, 86, 1)',
                        'rgba(75, 192, 192, 1)',
                        'rgba(153, 102, 255, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'right',
                    }
                }
            }
        });

        // View trade details
        const tradeDetailsModal = new bootstrap.Modal(document.getElementById('tradeDetailsModal'));
        
        document.querySelectorAll('.view-trade-details').forEach(button => {
            button.addEventListener('click', function() {
                const tradeId = this.getAttribute('data-trade-id');
                
                // Find trade data in table
                const row = this.closest('tr');
                
                if (row) {
                    const cells = row.getElementsByTagName('td');
                    
                    // Update modal with trade information
                    document.getElementById('detail-id').textContent = cells[0].textContent;
                    document.getElementById('detail-symbol').textContent = cells[1].textContent;
                    
                    // Type with badge
                    const typeText = cells[2].textContent.trim();
                    document.getElementById('detail-type').innerHTML = `<span class="badge ${typeText === 'LONG' ? 'bg-success' : 'bg-danger'}">${typeText}</span>`;
                    
                    document.getElementById('detail-entry').textContent = cells[3].textContent;
                    document.getElementById('detail-exit').textContent = cells[4].textContent;
                    document.getElementById('detail-quantity').textContent = cells[5].textContent;
                    document.getElementById('detail-pnl').textContent = cells[6].textContent;
                    document.getElementById('detail-pnl').className = cells[6].className;
                    
                    // Calculate duration (dummy data)
                    document.getElementById('detail-duration').textContent = '8 giờ 30 phút';
                    
                    // Exit reason with badge
                    const reasonText = cells[9].textContent.trim();
                    let badgeClass = 'bg-info';
                    
                    if (reasonText.includes('take_profit')) {
                        badgeClass = 'bg-success';
                    } else if (reasonText.includes('stop_loss')) {
                        badgeClass = 'bg-danger';
                    }
                    
                    document.getElementById('detail-reason').innerHTML = `<span class="badge ${badgeClass}">${reasonText}</span>`;
                    
                    // Initialize trade detail chart
                    const tradeChart = document.getElementById('tradeChartDetail').getContext('2d');
                    const detailChart = new Chart(tradeChart, {
                        type: 'line',
                        data: {
                            labels: ['Entry', '1h', '2h', '3h', '4h', '5h', '6h', '7h', '8h', 'Exit'],
                            datasets: [{
                                label: 'Price',
                                data: generateRandomPriceData(typeText === 'LONG'),
                                borderColor: '#0d6efd',
                                backgroundColor: 'rgba(13, 110, 253, 0.1)',
                                fill: true,
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                annotation: {
                                    annotations: {
                                        line1: {
                                            type: 'line',
                                            yMin: parseFloat(cells[3].textContent.replace('$', '')),
                                            yMax: parseFloat(cells[3].textContent.replace('$', '')),
                                            borderColor: 'rgba(255, 99, 132, 0.5)',
                                            borderWidth: 2,
                                            label: {
                                                content: 'Entry',
                                                enabled: true
                                            }
                                        },
                                        line2: {
                                            type: 'line',
                                            yMin: parseFloat(cells[4].textContent.replace('$', '')),
                                            yMax: parseFloat(cells[4].textContent.replace('$', '')),
                                            borderColor: 'rgba(54, 162, 235, 0.5)',
                                            borderWidth: 2,
                                            label: {
                                                content: 'Exit',
                                                enabled: true
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
                
                tradeDetailsModal.show();
            });
        });
        
        // Generate random price data for trade detail chart
        function generateRandomPriceData(isLong) {
            const length = 10;
            const startPrice = 65000;
            const endPrice = isLong ? 69000 : 62000;
            
            return Array(length).fill(0).map((_, i) => {
                if (i === 0) return startPrice;
                if (i === length - 1) return endPrice;
                
                // Create a curve toward the end price
                const progress = i / (length - 1);
                const randomFactor = Math.random() * 200 - 100; // Random fluctuation
                
                return startPrice + (endPrice - startPrice) * (isLong ? 
                    (Math.pow(progress, 2) + randomFactor) : 
                    (Math.pow(progress, 0.5) + randomFactor));
            });
        }
        
        // Handle time period selection for the chart
        document.querySelectorAll('.chart-period').forEach(button => {
            button.addEventListener('click', function() {
                document.querySelectorAll('.chart-period').forEach(btn => {
                    btn.classList.remove('active');
                });
                this.classList.add('active');
                
                const period = this.getAttribute('data-period');
                let data;
                
                switch(period) {
                    case '1w':
                        data = [3, 2, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0];
                        break;
                    case '1m':
                        data = [5, 7, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0];
                        break;
                    case '3m':
                        data = [5, 7, 3, 8, 6, 4, 0, 0, 0, 0, 0, 0];
                        break;
                    case 'all':
                    default:
                        data = [5, 7, 3, 8, 6, 4, 7, 9, 8, 10, 8, 12];
                }
                
                // Update data
                tradesDistributionChart.data.datasets[0].data = data;
                
                // Generate losing trades as around 30% of winning trades
                const losingData = data.map(val => Math.round(val * 0.3));
                tradesDistributionChart.data.datasets[1].data = losingData;
                
                tradesDistributionChart.update();
            });
        });
        
        // Table sorting
        document.querySelectorAll('.table-sort').forEach(header => {
            header.addEventListener('click', function(e) {
                e.preventDefault();
                
                const sortBy = this.getAttribute('data-sort');
                const table = document.getElementById('trades-table');
                const tbody = table.querySelector('tbody');
                const rows = Array.from(tbody.querySelectorAll('tr'));
                
                // Get current direction from icon
                const icon = this.querySelector('i');
                const isAscending = icon.classList.contains('fa-sort') || icon.classList.contains('fa-sort-down');
                
                // Update all icons to default
                document.querySelectorAll('.table-sort i').forEach(i => {
                    i.className = 'fas fa-sort';
                });
                
                // Update clicked header icon
                icon.className = isAscending ? 'fas fa-sort-up' : 'fas fa-sort-down';
                
                // Sort rows
                rows.sort((a, b) => {
                    let aValue = a.cells[Array.from(a.parentNode.parentNode.querySelector('thead tr').cells).findIndex(cell => cell.querySelector(`[data-sort="${sortBy}"]`))].textContent.trim();
                    let bValue = b.cells[Array.from(b.parentNode.parentNode.querySelector('thead tr').cells).findIndex(cell => cell.querySelector(`[data-sort="${sortBy}"]`))].textContent.trim();
                    
                    // Handle numeric values
                    if (sortBy === 'entry_price' || sortBy === 'exit_price' || sortBy === 'pnl') {
                        aValue = parseFloat(aValue.replace(/[^\d.-]/g, ''));
                        bValue = parseFloat(bValue.replace(/[^\d.-]/g, ''));
                    }
                    
                    // Handle dates
                    if (sortBy === 'entry_time' || sortBy === 'exit_time') {
                        aValue = new Date(aValue);
                        bValue = new Date(bValue);
                    }
                    
                    if (isAscending) {
                        return aValue > bValue ? 1 : -1;
                    } else {
                        return aValue < bValue ? 1 : -1;
                    }
                });
                
                // Reappend rows in sorted order
                rows.forEach(row => {
                    tbody.appendChild(row);
                });
            });
        });
        
        // Search functionality
        document.getElementById('search-btn').addEventListener('click', function() {
            const searchTerm = document.getElementById('trade-search').value.toLowerCase();
            const rows = document.querySelectorAll('#trades-table tbody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        });
        
        // Reset search when search box is cleared
        document.getElementById('trade-search').addEventListener('input', function() {
            if (this.value === '') {
                document.querySelectorAll('#trades-table tbody tr').forEach(row => {
                    row.style.display = '';
                });
            }
        });
        
        // Apply filters
        document.getElementById('apply-filters').addEventListener('click', function() {
            const filterLong = document.getElementById('filter-long').checked;
            const filterShort = document.getElementById('filter-short').checked;
            const filterProfit = document.getElementById('filter-profit').checked;
            const filterLoss = document.getElementById('filter-loss').checked;
            
            document.querySelectorAll('#trades-table tbody tr').forEach(row => {
                const type = row.querySelector('td:nth-child(3)').textContent.trim();
                const isLong = type.includes('LONG');
                const isProfit = row.classList.contains('table-success');
                
                const typeMatch = (isLong && filterLong) || (!isLong && filterShort);
                const resultMatch = (isProfit && filterProfit) || (!isProfit && filterLoss);
                
                row.style.display = typeMatch && resultMatch ? '' : 'none';
            });
        });
        
        // Download CSV
        document.getElementById('download-csv').addEventListener('click', function() {
            const table = document.getElementById('trades-table');
            const headers = Array.from(table.querySelectorAll('thead th')).map(th => {
                const sortLink = th.querySelector('.table-sort');
                return sortLink ? sortLink.getAttribute('data-sort') : 'action';
            });
            
            const rows = Array.from(table.querySelectorAll('tbody tr')).map(row => {
                return Array.from(row.querySelectorAll('td')).map(cell => {
                    return `"${cell.textContent.trim().replace(/"/g, '""')}"`;
                }).join(',');
            });
            
            const csv = [headers.join(','), ...rows].join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.setAttribute('hidden', '');
            a.setAttribute('href', url);
            a.setAttribute('download', 'trades.csv');
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        });
        
        // Pagination (dummy)
        document.querySelectorAll('.pagination .page-link').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                if (this.textContent !== 'Trước' && this.textContent !== 'Sau') {
                    document.querySelectorAll('.pagination .page-item').forEach(item => {
                        item.classList.remove('active');
                    });
                    this.parentNode.classList.add('active');
                }
            });
        });
    });
</script>
{% endblock %}