{% extends 'common_layout.html' %}

{% set active_page = 'trades' %}

{% block title %}Lịch sử giao dịch - Bot Giao Dịch Crypto{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <h2 class="mb-3">Lịch sử giao dịch</h2>
            
            <!-- API Mode Indicator -->
            <div class="d-flex align-items-center mb-3">
                {% if bot_status.mode == 'demo' %}
                <div class="status-badge bg-secondary me-2">
                    <i class="bi bi-life-preserver me-1"></i> Demo Mode
                </div>
                {% elif bot_status.mode == 'testnet' %}
                <div class="status-badge testnet me-2">
                    <i class="bi bi-exclamation-triangle-fill me-1"></i> Testnet Mode
                </div>
                {% else %}
                <div class="status-badge live me-2">
                    <i class="bi bi-check-circle-fill me-1"></i> Live Mode
                </div>
                {% endif %}
                
                <div class="status-badge {{ 'connected' if bot_status.api_connected else 'disconnected' }} me-2">
                    <i class="bi {{ 'bi-plug-fill' if bot_status.api_connected else 'bi-plug' }} me-1"></i>
                    {{ 'Đã kết nối' if bot_status.api_connected else 'Chưa kết nối' }}
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Left Column - Trades History -->
        <div class="col-md-8">
            <div class="info-card">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">Lịch sử giao dịch</h5>
                    <div>
                        <button id="refreshTradesBtn" class="btn btn-sm btn-outline-primary me-2">
                            <i class="bi bi-arrow-clockwise me-1"></i>Làm mới
                        </button>
                        
                        <div class="btn-group">
                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="bi bi-funnel me-1"></i>
                                Lọc
                            </button>
                            <ul class="dropdown-menu">
                                <li>
                                    <div class="px-3 py-2">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="filterProfit" checked>
                                            <label class="form-check-label" for="filterProfit">
                                                <span class="badge bg-success">Lợi nhuận</span>
                                            </label>
                                        </div>
                                    </div>
                                </li>
                                <li>
                                    <div class="px-3 py-2">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="filterLoss" checked>
                                            <label class="form-check-label" for="filterLoss">
                                                <span class="badge bg-danger">Lỗ</span>
                                            </label>
                                        </div>
                                    </div>
                                </li>
                                <li><hr class="dropdown-divider"></li>
                                <li>
                                    <div class="px-3 py-2">
                                        <div class="form-group">
                                            <label for="symbolFilter" class="form-label">Cặp giao dịch</label>
                                            <select class="form-select form-select-sm" id="symbolFilter">
                                                <option value="">Tất cả</option>
                                                {% for symbol in fake_symbols %}
                                                <option value="{{ symbol }}">{{ symbol }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                </li>
                                <li>
                                    <div class="px-3 py-2">
                                        <div class="form-group">
                                            <label for="timeframeFilter" class="form-label">Thời gian</label>
                                            <select class="form-select form-select-sm" id="timeframeFilter">
                                                <option value="all">Tất cả</option>
                                                <option value="today">Hôm nay</option>
                                                <option value="yesterday">Hôm qua</option>
                                                <option value="week">Tuần này</option>
                                                <option value="month">Tháng này</option>
                                            </select>
                                        </div>
                                    </div>
                                </li>
                                <li><hr class="dropdown-divider"></li>
                                <li>
                                    <div class="d-grid px-3 py-2">
                                        <button class="btn btn-sm btn-primary" id="applyFiltersBtn">
                                            Áp dụng bộ lọc
                                        </button>
                                    </div>
                                </li>
                            </ul>
                        </div>
                        
                        <button id="exportTradesBtn" class="btn btn-sm btn-outline-secondary">
                            <i class="bi bi-download me-1"></i>
                            Xuất CSV
                        </button>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="table table-sm custom-table" id="tradesTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Symbol</th>
                                <th>Loại</th>
                                <th>Giá vào</th>
                                <th>Giá ra</th>
                                <th>Khối lượng</th>
                                <th>P/L</th>
                                <th>Thời gian</th>
                                <th>Chiến lược</th>
                                <th>Lý do đóng</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if trades and trades|length > 0 %}
                                {% for trade in trades %}
                                <tr class="{{ 'bg-success bg-opacity-10' if trade.pnl > 0 else 'bg-danger bg-opacity-10' if trade.pnl < 0 else '' }}">
                                    <td><small>{{ trade.id[:6] }}</small></td>
                                    <td>{{ trade.symbol }}</td>
                                    <td>
                                        <span class="badge bg-{{ 'success' if trade.side == 'BUY' else 'danger' }}">
                                            {{ trade.side }}
                                        </span>
                                    </td>
                                    <td>${{ trade.entry_price|round(2) }}</td>
                                    <td>${{ trade.exit_price|round(2) }}</td>
                                    <td>{{ trade.quantity|round(4) }}</td>
                                    <td class="{{ 'text-success' if trade.pnl > 0 else 'text-danger' if trade.pnl < 0 else '' }}">
                                        ${{ trade.pnl|round(2) }} ({{ trade.pnl_percent|round(2) }}%)
                                    </td>
                                    <td>
                                        <small>{{ trade.exit_time }}</small>
                                    </td>
                                    <td>{{ trade.strategy }}</td>
                                    <td>
                                        <span class="badge 
                                            {% if trade.reason == 'Take Profit' %}bg-success
                                            {% elif trade.reason == 'Stop Loss' %}bg-danger
                                            {% elif trade.reason == 'Trailing Stop' %}bg-warning text-dark
                                            {% else %}bg-secondary
                                            {% endif %}">
                                            {{ trade.reason }}
                                        </span>
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="10" class="text-center py-3">
                                        Không có dữ liệu giao dịch
                                    </td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
                
                <div class="d-flex justify-content-between align-items-center mt-3">
                    <div>
                        <span class="me-2">Hiển thị {{ trades|default([])|length }} giao dịch</span>
                    </div>
                    <nav aria-label="Phân trang">
                        <ul class="pagination pagination-sm">
                            <li class="page-item disabled">
                                <a class="page-link" href="#" tabindex="-1" aria-disabled="true">Trước</a>
                            </li>
                            <li class="page-item active" aria-current="page">
                                <a class="page-link" href="#">1</a>
                            </li>
                            <li class="page-item"><a class="page-link" href="#">2</a></li>
                            <li class="page-item"><a class="page-link" href="#">3</a></li>
                            <li class="page-item">
                                <a class="page-link" href="#">Sau</a>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
        
        <!-- Right Column - Trade Statistics -->
        <div class="col-md-4">
            <!-- Performance Summary -->
            <div class="info-card">
                <h5 class="mb-3">Tổng kết hiệu suất</h5>
                
                <div class="row mb-3">
                    <div class="col-6">
                        <div class="info-label">Tổng số giao dịch</div>
                        <div class="info-value">{{ trades|default([])|length }}</div>
                    </div>
                    <div class="col-6">
                        <div class="info-label">Tỷ lệ thắng</div>
                        {% set winning_trades = 0 %}
                        {% if trades %}
                            {% for trade in trades %}
                                {% if trade.pnl > 0 %}
                                    {% set winning_trades = winning_trades + 1 %}
                                {% endif %}
                            {% endfor %}
                        {% endif %}
                        {% set win_rate = (winning_trades / trades|length * 100)|round(1) if trades|default([])|length > 0 else 0 %}
                        <div class="info-value">{{ win_rate }}%</div>
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-6">
                        <div class="info-label">Tổng lợi nhuận</div>
                        {% set total_profit = 0 %}
                        {% if trades %}
                            {% for trade in trades %}
                                {% set total_profit = total_profit + trade.pnl %}
                            {% endfor %}
                        {% endif %}
                        <div class="info-value {% if total_profit > 0 %}text-success{% elif total_profit < 0 %}text-danger{% endif %}">
                            ${{ total_profit|round(2) }}
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="info-label">Profit Factor</div>
                        {% set total_profit_amount = 0 %}
                        {% set total_loss_amount = 0 %}
                        {% if trades %}
                            {% for trade in trades %}
                                {% if trade.pnl > 0 %}
                                    {% set total_profit_amount = total_profit_amount + trade.pnl %}
                                {% else %}
                                    {% set total_loss_amount = total_loss_amount + (trade.pnl|abs) %}
                                {% endif %}
                            {% endfor %}
                        {% endif %}
                        {% set profit_factor = (total_profit_amount / total_loss_amount)|round(2) if total_loss_amount > 0 else 0 %}
                        <div class="info-value">{{ profit_factor }}</div>
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-6">
                        <div class="info-label">Trung bình thắng</div>
                        {% set avg_win = 0 %}
                        {% if winning_trades > 0 %}
                            {% set avg_win = (total_profit_amount / winning_trades)|round(2) %}
                        {% endif %}
                        <div class="info-value text-success">${{ avg_win }}</div>
                    </div>
                    <div class="col-6">
                        <div class="info-label">Trung bình thua</div>
                        {% set losing_trades = trades|default([])|length - winning_trades %}
                        {% set avg_loss = 0 %}
                        {% if losing_trades > 0 %}
                            {% set avg_loss = (total_loss_amount / losing_trades)|round(2) %}
                        {% endif %}
                        <div class="info-value text-danger">-${{ avg_loss }}</div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <div class="info-label">Hiệu suất (thời gian thực)</div>
                    <div class="chart-container mt-2" style="height: 200px;">
                        <canvas id="performanceChart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Trade Distributions -->
            <div class="info-card">
                <h5 class="mb-3">Phân tích giao dịch</h5>
                
                <div class="mb-3">
                    <div class="info-label">Phân bố theo Symbol</div>
                    <div class="chart-container mt-2" style="height: 180px;">
                        <canvas id="symbolDistributionChart"></canvas>
                    </div>
                </div>
                
                <div class="mb-3">
                    <div class="info-label">Phân bố theo Chiến lược</div>
                    <div class="chart-container mt-2" style="height: 180px;">
                        <canvas id="strategyDistributionChart"></canvas>
                    </div>
                </div>
                
                <div>
                    <div class="info-label">Lý do đóng vị thế</div>
                    <div class="chart-container mt-2" style="height: 180px;">
                        <canvas id="exitReasonChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Trade Detail Modal -->
<div class="modal fade" id="tradeDetailModal" tabindex="-1" aria-labelledby="tradeDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header">
                <h5 class="modal-title" id="tradeDetailModalLabel">Chi tiết giao dịch</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <h5 id="tradeDetailSymbol">BTCUSDT</h5>
                        <span class="badge bg-success" id="tradeDetailType">BUY</span>
                        <span class="badge bg-secondary" id="tradeDetailStrategy">RSI</span>
                    </div>
                    <div class="col-md-6 text-md-end">
                        <div class="info-value" id="tradeDetailPnl">+$350.00 (4.2%)</div>
                        <div class="small" id="tradeDetailTime">2025-02-28 20:15:30</div>
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-3 col-6">
                        <div class="info-label">Giá vào</div>
                        <div id="tradeDetailEntryPrice">$72000.00</div>
                    </div>
                    <div class="col-md-3 col-6">
                        <div class="info-label">Giá ra</div>
                        <div id="tradeDetailExitPrice">$75000.00</div>
                    </div>
                    <div class="col-md-3 col-6">
                        <div class="info-label">Khối lượng</div>
                        <div id="tradeDetailQuantity">0.1</div>
                    </div>
                    <div class="col-md-3 col-6">
                        <div class="info-label">Lý do đóng</div>
                        <div id="tradeDetailReason">Take Profit</div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <div class="info-label">Chart</div>
                    <div class="chart-container" style="height: 300px;">
                        <canvas id="tradeDetailChart"></canvas>
                    </div>
                </div>
                
                <div class="mb-3">
                    <div class="info-label">Chỉ báo kỹ thuật</div>
                    <div class="row">
                        <div class="col-md-3 col-6">
                            <div class="info-label">RSI</div>
                            <div id="tradeDetailRsi">48.5</div>
                        </div>
                        <div class="col-md-3 col-6">
                            <div class="info-label">MACD</div>
                            <div id="tradeDetailMacd">+125.8</div>
                        </div>
                        <div class="col-md-3 col-6">
                            <div class="info-label">BB Width</div>
                            <div id="tradeDetailBbWidth">2.5%</div>
                        </div>
                        <div class="col-md-3 col-6">
                            <div class="info-label">ATR</div>
                            <div id="tradeDetailAtr">1250.5</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Performance Chart
        const performanceCtx = document.getElementById('performanceChart').getContext('2d');
        const performanceChart = new Chart(performanceCtx, {
            type: 'line',
            data: {
                labels: [
                    {% for trade in trades|default([])|reverse %}
                    '{{ trade.exit_time }}',
                    {% endfor %}
                ],
                datasets: [{
                    label: 'P/L Tích lũy',
                    data: (function() {
                        let cumulative = 0;
                        let data = [];
                        {% for trade in trades|default([])|reverse %}
                        cumulative += {{ trade.pnl }};
                        data.push(cumulative);
                        {% endfor %}
                        return data;
                    })(),
                    borderColor: 'rgba(75, 192, 192, 1)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `P/L tích lũy: $${context.raw.toFixed(2)}`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        }
                    },
                    x: {
                        display: false
                    }
                }
            }
        });

        // Symbol Distribution Chart
        const symbolDistCtx = document.getElementById('symbolDistributionChart').getContext('2d');
        
        // Count trades by symbol
        const symbolCounts = {};
        {% for trade in trades|default([]) %}
        if (!symbolCounts['{{ trade.symbol }}']) {
            symbolCounts['{{ trade.symbol }}'] = 0;
        }
        symbolCounts['{{ trade.symbol }}'] += 1;
        {% endfor %}
        
        const symbolLabels = Object.keys(symbolCounts);
        const symbolData = symbolLabels.map(key => symbolCounts[key]);
        
        const symbolDistChart = new Chart(symbolDistCtx, {
            type: 'pie',
            data: {
                labels: symbolLabels,
                datasets: [{
                    data: symbolData,
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.7)',
                        'rgba(54, 162, 235, 0.7)',
                        'rgba(255, 206, 86, 0.7)',
                        'rgba(75, 192, 192, 0.7)',
                        'rgba(153, 102, 255, 0.7)',
                        'rgba(255, 159, 64, 0.7)',
                        'rgba(199, 199, 199, 0.7)'
                    ],
                    borderColor: [
                        'rgba(255, 99, 132, 1)',
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 206, 86, 1)',
                        'rgba(75, 192, 192, 1)',
                        'rgba(153, 102, 255, 1)',
                        'rgba(255, 159, 64, 1)',
                        'rgba(199, 199, 199, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            boxWidth: 15,
                            padding: 10
                        }
                    }
                }
            }
        });

        // Strategy Distribution Chart
        const strategyDistCtx = document.getElementById('strategyDistributionChart').getContext('2d');
        
        // Count trades by strategy
        const strategyCounts = {};
        {% for trade in trades|default([]) %}
        if (!strategyCounts['{{ trade.strategy }}']) {
            strategyCounts['{{ trade.strategy }}'] = 0;
        }
        strategyCounts['{{ trade.strategy }}'] += 1;
        {% endfor %}
        
        const strategyLabels = Object.keys(strategyCounts);
        const strategyData = strategyLabels.map(key => strategyCounts[key]);
        
        const strategyDistChart = new Chart(strategyDistCtx, {
            type: 'doughnut',
            data: {
                labels: strategyLabels,
                datasets: [{
                    data: strategyData,
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.7)',
                        'rgba(54, 162, 235, 0.7)',
                        'rgba(255, 206, 86, 0.7)',
                        'rgba(75, 192, 192, 0.7)',
                        'rgba(153, 102, 255, 0.7)',
                        'rgba(255, 159, 64, 0.7)',
                        'rgba(199, 199, 199, 0.7)'
                    ],
                    borderColor: [
                        'rgba(255, 99, 132, 1)',
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 206, 86, 1)',
                        'rgba(75, 192, 192, 1)',
                        'rgba(153, 102, 255, 1)',
                        'rgba(255, 159, 64, 1)',
                        'rgba(199, 199, 199, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            boxWidth: 15,
                            padding: 10
                        }
                    }
                }
            }
        });

        // Exit Reason Chart
        const exitReasonCtx = document.getElementById('exitReasonChart').getContext('2d');
        
        // Count trades by exit reason
        const reasonCounts = {};
        {% for trade in trades|default([]) %}
        if (!reasonCounts['{{ trade.reason }}']) {
            reasonCounts['{{ trade.reason }}'] = 0;
        }
        reasonCounts['{{ trade.reason }}'] += 1;
        {% endfor %}
        
        const reasonLabels = Object.keys(reasonCounts);
        const reasonData = reasonLabels.map(key => reasonCounts[key]);
        
        const exitReasonChart = new Chart(exitReasonCtx, {
            type: 'bar',
            data: {
                labels: reasonLabels,
                datasets: [{
                    label: 'Số lượng',
                    data: reasonData,
                    backgroundColor: [
                        'rgba(40, 167, 69, 0.7)',  // Take Profit (green)
                        'rgba(220, 53, 69, 0.7)',  // Stop Loss (red)
                        'rgba(255, 193, 7, 0.7)',  // Trailing Stop (yellow)
                        'rgba(108, 117, 125, 0.7)' // Manual/Other (gray)
                    ],
                    borderColor: [
                        'rgba(40, 167, 69, 1)',
                        'rgba(220, 53, 69, 1)',
                        'rgba(255, 193, 7, 1)',
                        'rgba(108, 117, 125, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });

        // Trade detail modal
        const tradeRows = document.querySelectorAll('#tradesTable tbody tr');
        const tradeDetailModal = new bootstrap.Modal(document.getElementById('tradeDetailModal'));
        
        tradeRows.forEach(row => {
            row.addEventListener('click', function() {
                // Get trade ID from first cell
                const tradeId = this.cells[0].textContent.trim();
                openTradeDetail(tradeId);
            });
        });
        
        function openTradeDetail(tradeId) {
            // In real app, fetch trade detail from API
            // For demo, we'll use the trades data from Jinja template
            
            {% for trade in trades|default([]) %}
            if ('{{ trade.id }}'.includes(tradeId)) {
                document.getElementById('tradeDetailSymbol').textContent = '{{ trade.symbol }}';
                document.getElementById('tradeDetailType').textContent = '{{ trade.side }}';
                document.getElementById('tradeDetailType').className = 'badge bg-{{ 'success' if trade.side == 'BUY' else 'danger' }}';
                document.getElementById('tradeDetailStrategy').textContent = '{{ trade.strategy }}';
                
                const pnlEl = document.getElementById('tradeDetailPnl');
                pnlEl.textContent = `${{{ trade.pnl }} >= 0 ? '+' : ''}${{ trade.pnl|round(2) }} ({{ trade.pnl_percent|round(2) }}%)`;
                pnlEl.className = {{ trade.pnl }} >= 0 ? 'info-value text-success' : 'info-value text-danger';
                
                document.getElementById('tradeDetailTime').textContent = '{{ trade.exit_time }}';
                document.getElementById('tradeDetailEntryPrice').textContent = '${{ trade.entry_price|round(2) }}';
                document.getElementById('tradeDetailExitPrice').textContent = '${{ trade.exit_price|round(2) }}';
                document.getElementById('tradeDetailQuantity').textContent = '{{ trade.quantity|round(4) }}';
                document.getElementById('tradeDetailReason').textContent = '{{ trade.reason }}';
                
                // Update indicator values (random in demo)
                document.getElementById('tradeDetailRsi').textContent = (Math.random() * 100).toFixed(1);
                document.getElementById('tradeDetailMacd').textContent = ((Math.random() * 2 - 1) * 200).toFixed(1);
                document.getElementById('tradeDetailBbWidth').textContent = (Math.random() * 5).toFixed(2) + '%';
                document.getElementById('tradeDetailAtr').textContent = (Math.random() * 2000 + 500).toFixed(1);
                
                // Generate trade chart
                generateTradeDetailChart('{{ trade.symbol }}', '{{ trade.side }}', {{ trade.entry_price }}, {{ trade.exit_price }});
                
                // Show modal
                tradeDetailModal.show();
                
                break;
            }
            {% endfor %}
        }
        
        function generateTradeDetailChart(symbol, side, entryPrice, exitPrice) {
            const ctx = document.getElementById('tradeDetailChart').getContext('2d');
            
            // Generate random price data for demonstration
            const length = 50;
            const startPrice = entryPrice * 0.98;
            const priceData = [];
            
            for (let i = 0; i < length; i++) {
                if (i < length / 3) {
                    // Price approaching entry
                    priceData.push(startPrice * (1 + (i / (length / 3)) * 0.02));
                } else if (i === Math.floor(length / 3)) {
                    // Entry point
                    priceData.push(entryPrice);
                } else if (i < length * 2 / 3) {
                    // Price moving after entry
                    if (side === 'BUY') {
                        // For buy trades, price typically goes up
                        priceData.push(entryPrice * (1 + ((i - length / 3) / (length / 3)) * (exitPrice / entryPrice - 1) * 0.8));
                    } else {
                        // For sell trades, price typically goes down
                        priceData.push(entryPrice * (1 - ((i - length / 3) / (length / 3)) * (entryPrice / exitPrice - 1) * 0.8));
                    }
                } else if (i === Math.floor(length * 2 / 3)) {
                    // Exit point
                    priceData.push(exitPrice);
                } else {
                    // Price after exit
                    if (side === 'BUY') {
                        // For buy trades, price might continue up or pull back
                        const change = (Math.random() * 0.02 - 0.01) + 0.005;
                        priceData.push(exitPrice * (1 + change));
                    } else {
                        // For sell trades, price might continue down or bounce
                        const change = (Math.random() * 0.02 - 0.01) - 0.005;
                        priceData.push(exitPrice * (1 + change));
                    }
                }
            }
            
            // Add some noise to the data
            for (let i = 0; i < priceData.length; i++) {
                priceData[i] = priceData[i] * (1 + (Math.random() * 0.006 - 0.003));
            }
            
            // Generate labels (dates)
            const labels = [];
            for (let i = 0; i < length; i++) {
                labels.push(i.toString());
            }
            
            // Destroy previous chart if exists
            if (window.tradeChart) {
                window.tradeChart.destroy();
            }
            
            // Create chart
            window.tradeChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: symbol + ' Price',
                        data: priceData,
                        borderColor: side === 'BUY' ? 'rgba(40, 167, 69, 1)' : 'rgba(220, 53, 69, 1)',
                        backgroundColor: side === 'BUY' ? 'rgba(40, 167, 69, 0.1)' : 'rgba(220, 53, 69, 0.1)',
                        pointRadius: 0,
                        pointHoverRadius: 5,
                        tension: 0.3,
                        fill: true
                    }, {
                        label: 'Entry Price',
                        data: Array(length).fill(entryPrice),
                        borderColor: 'rgba(108, 117, 125, 0.8)',
                        borderDash: [5, 5],
                        pointRadius: 0,
                        fill: false
                    }, {
                        label: 'Exit Price',
                        data: Array(length).fill(exitPrice),
                        borderColor: 'rgba(23, 162, 184, 0.8)',
                        borderDash: [5, 5],
                        pointRadius: 0,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        annotation: {
                            annotations: {
                                entry: {
                                    type: 'point',
                                    xValue: Math.floor(length / 3),
                                    yValue: entryPrice,
                                    backgroundColor: 'rgba(108, 117, 125, 1)',
                                    radius: 5
                                },
                                exit: {
                                    type: 'point',
                                    xValue: Math.floor(length * 2 / 3),
                                    yValue: exitPrice,
                                    backgroundColor: 'rgba(23, 162, 184, 1)',
                                    radius: 5
                                }
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }
        
        // Refresh Trades Button
        document.getElementById('refreshTradesBtn').addEventListener('click', function() {
            // Show loading
            showLoading();
            
            // Send API request to get trades
            fetch('/api/trades')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast('Thành công', 'Dữ liệu giao dịch đã được làm mới', 'success');
                        
                        // Reload page
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                    } else {
                        showToast('Lỗi', data.message, 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('Lỗi', 'Không thể kết nối với máy chủ', 'error');
                })
                .finally(() => {
                    hideLoading();
                });
        });
        
        // Export Trades Button
        document.getElementById('exportTradesBtn').addEventListener('click', function() {
            // Get table data
            const table = document.getElementById('tradesTable');
            const rows = Array.from(table.querySelectorAll('tbody tr'));
            
            // Create CSV content
            let csvContent = 'ID,Symbol,Type,Entry Price,Exit Price,Quantity,PnL,PnL %,Exit Time,Strategy,Reason\n';
            
            rows.forEach(row => {
                const cells = Array.from(row.querySelectorAll('td'));
                if (cells.length > 0) {
                    const rowData = cells.map(cell => {
                        // Remove $ and % symbols
                        let text = cell.textContent.trim().replace('$', '').replace('%', '');
                        // For cells with nested elements, clean up the text
                        if (text.includes('\n')) {
                            text = text.replace(/\s+/g, ' ').trim();
                        }
                        // Escape commas
                        if (text.includes(',')) {
                            return `"${text}"`;
                        }
                        return text;
                    });
                    csvContent += rowData.join(',') + '\n';
                }
            });
            
            // Create download link
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', 'trades_export.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showToast('Thành công', 'Dữ liệu giao dịch đã được xuất thành công', 'success');
        });
        
        // Apply Filters Button
        document.getElementById('applyFiltersBtn').addEventListener('click', function() {
            const showProfit = document.getElementById('filterProfit').checked;
            const showLoss = document.getElementById('filterLoss').checked;
            const symbolFilter = document.getElementById('symbolFilter').value;
            const timeframeFilter = document.getElementById('timeframeFilter').value;
            
            // Filter rows
            const rows = document.querySelectorAll('#tradesTable tbody tr');
            
            rows.forEach(row => {
                let show = true;
                
                // Filter by profit/loss
                const pnlCell = row.querySelector('td:nth-child(7)');
                if (pnlCell) {
                    const pnlText = pnlCell.textContent;
                    const isProfitable = pnlText.includes('+') || !pnlText.includes('-');
                    
                    if ((isProfitable && !showProfit) || (!isProfitable && !showLoss)) {
                        show = false;
                    }
                }
                
                // Filter by symbol
                if (symbolFilter && row.querySelector('td:nth-child(2)')) {
                    const symbol = row.querySelector('td:nth-child(2)').textContent.trim();
                    if (symbol !== symbolFilter) {
                        show = false;
                    }
                }
                
                // Filter by timeframe
                if (timeframeFilter !== 'all' && row.querySelector('td:nth-child(8)')) {
                    const timeText = row.querySelector('td:nth-child(8)').textContent.trim();
                    const tradeDate = new Date(timeText);
                    const now = new Date();
                    
                    if (timeframeFilter === 'today') {
                        // Check if date is today
                        if (tradeDate.toDateString() !== now.toDateString()) {
                            show = false;
                        }
                    } else if (timeframeFilter === 'yesterday') {
                        // Check if date is yesterday
                        const yesterday = new Date();
                        yesterday.setDate(now.getDate() - 1);
                        if (tradeDate.toDateString() !== yesterday.toDateString()) {
                            show = false;
                        }
                    } else if (timeframeFilter === 'week') {
                        // Check if date is this week
                        const weekStart = new Date(now);
                        weekStart.setDate(now.getDate() - now.getDay());
                        weekStart.setHours(0, 0, 0, 0);
                        
                        if (tradeDate < weekStart) {
                            show = false;
                        }
                    } else if (timeframeFilter === 'month') {
                        // Check if date is this month
                        if (tradeDate.getMonth() !== now.getMonth() || 
                            tradeDate.getFullYear() !== now.getFullYear()) {
                            show = false;
                        }
                    }
                }
                
                // Show or hide row
                row.style.display = show ? '' : 'none';
            });
        });
    });
</script>
{% endblock %}