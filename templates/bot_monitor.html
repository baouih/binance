{% extends "layout.html" %}

{% block title %}Giám sát Bot{% endblock %}

{% block styles %}
<style>
    .log-item {
        border-left: 3px solid #ccc;
        padding: 10px;
        margin-bottom: 8px;
        transition: all 0.3s ease;
    }
    .log-item:hover {
        background-color: rgba(0,0,0,0.05);
    }
    .log-item.market {
        border-left-color: #0dcaf0; /* info */
    }
    .log-item.analysis {
        border-left-color: #6c757d; /* secondary */
    }
    .log-item.decision {
        border-left-color: #ffc107; /* warning */
    }
    .log-item.action {
        border-left-color: #198754; /* success */
    }
    .log-item.error {
        border-left-color: #dc3545; /* danger */
    }

    .data-card {
        height: 100%;
        transition: all 0.3s ease;
    }
    .data-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    
    .decision-item {
        border: 1px solid rgba(0,0,0,.125);
        border-radius: .25rem;
        padding: 15px;
        margin-bottom: 15px;
        transition: all 0.2s;
    }
    .decision-item:hover {
        box-shadow: 0 5px 15px rgba(0,0,0,0.08);
    }
    .decision-item.buy {
        border-left: 4px solid #198754;
    }
    .decision-item.sell {
        border-left: 4px solid #dc3545;
    }
    .decision-item.hold {
        border-left: 4px solid #ffc107;
    }
    
    .reason-item {
        padding: 5px 10px;
        margin: 2px 0;
        background-color: rgba(0,0,0,.03);
        border-radius: 4px;
        font-size: 14px;
    }
    
    .stats-counter {
        font-size: 24px;
        font-weight: bold;
    }
    
    .counter-label {
        font-size: 14px;
        color: #6c757d;
    }
    
    #logContainer {
        max-height: 400px;
        overflow-y: auto;
    }
    
    #decisionsContainer {
        max-height: 500px;
        overflow-y: auto;
    }
    
    .timestamp {
        font-size: 12px;
        color: #6c757d;
    }
    
    .bot-controls {
        position: sticky;
        top: 0;
        background: var(--bs-body-bg);
        z-index: 1000;
        padding: 15px 0;
        border-bottom: 1px solid rgba(0,0,0,.1);
    }
    
    .last-update {
        font-size: 12px;
        color: #6c757d;
    }
    
    /* Animations */
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }
    
    .pulse-animation {
        animation: pulse 2s infinite;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid my-4">
    <div class="row mb-4">
        <div class="col-12">
            <h2 class="mb-3"><i class="fas fa-desktop me-2"></i> Giám sát Bot</h2>
            
            <div class="bot-controls card mb-4">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-4">
                            <div class="d-flex align-items-center">
                                <select id="botSelector" class="form-select me-2">
                                    <option value="all">Tất cả Bot</option>
                                    <option value="bot1">Bot 1 - BTCUSDT</option>
                                    <option value="bot2">Bot 2 - ETHUSDT</option>
                                </select>
                                <button id="refreshButton" class="btn btn-outline-primary">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-4 text-center">
                            <div id="botStatusBadge" class="badge rounded-pill text-bg-success fs-6 px-3 py-2">
                                <i class="fas fa-circle-notch fa-spin me-1"></i> Bot đang hoạt động
                            </div>
                        </div>
                        <div class="col-md-4 text-end">
                            <button id="startBotBtn" class="btn btn-success me-2">
                                <i class="fas fa-play me-1"></i> Bắt đầu
                            </button>
                            <button id="stopBotBtn" class="btn btn-danger">
                                <i class="fas fa-stop me-1"></i> Dừng
                            </button>
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-12 text-end">
                            <span class="last-update">Cập nhật lần cuối: <span id="lastUpdateTime">Vừa xong</span></span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row g-3 mb-4">
                <div class="col-md-3">
                    <div class="card data-card">
                        <div class="card-body text-center">
                            <div class="d-flex align-items-center justify-content-between mb-3">
                                <h5 class="card-title mb-0">Thời gian hoạt động</h5>
                                <i class="fas fa-clock text-primary"></i>
                            </div>
                            <div class="stats-counter" id="uptimeCounter">14h 35m</div>
                            <div class="counter-label">Liên tục</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card data-card">
                        <div class="card-body text-center">
                            <div class="d-flex align-items-center justify-content-between mb-3">
                                <h5 class="card-title mb-0">Phân tích thị trường</h5>
                                <i class="fas fa-chart-line text-info"></i>
                            </div>
                            <div class="stats-counter" id="analysisCounter">342</div>
                            <div class="counter-label">Lần phân tích</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card data-card">
                        <div class="card-body text-center">
                            <div class="d-flex align-items-center justify-content-between mb-3">
                                <h5 class="card-title mb-0">Quyết định</h5>
                                <i class="fas fa-brain text-warning"></i>
                            </div>
                            <div class="stats-counter" id="decisionsCounter">28</div>
                            <div class="counter-label">Lần ra quyết định</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card data-card">
                        <div class="card-body text-center">
                            <div class="d-flex align-items-center justify-content-between mb-3">
                                <h5 class="card-title mb-0">Lệnh giao dịch</h5>
                                <i class="fas fa-exchange-alt text-success"></i>
                            </div>
                            <div class="stats-counter" id="ordersCounter">12</div>
                            <div class="counter-label">Lệnh đã thực thi</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-lightbulb me-2 text-warning"></i>
                        Quyết định giao dịch gần đây
                    </h5>
                    <button class="btn btn-sm btn-outline-secondary" id="refreshDecisions">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                <div class="card-body">
                    <div id="decisionsContainer">
                        <!-- Quyết định sẽ được thêm vào đây bằng JavaScript -->
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Đang tải quyết định giao dịch...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-list-alt me-2 text-info"></i>
                        Nhật ký hoạt động
                    </h5>
                    <button class="btn btn-sm btn-outline-secondary" id="refreshLogs">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                <div class="card-body">
                    <div id="logContainer">
                        <!-- Log entries sẽ được thêm vào đây bằng JavaScript -->
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Đang tải nhật ký hoạt động...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.socket.io/4.4.1/socket.io.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Khởi tạo kết nối Socket.IO
    const socket = io();
    
    // Xử lý sự kiện cập nhật trạng thái bot
    socket.on('bot_status_update', function(data) {
        // Cập nhật trạng thái hiển thị
        updateBotStatusDisplay(data);
        
        // Cập nhật thông tin thống kê nếu có
        if(data.stats) {
            updateStatsDisplay(data.stats);
        }
        
        // Hiển thị thông báo
        showToast('success', 'Trạng thái bot đã được cập nhật');
    });
    
    // Xử lý sự kiện thay đổi trạng thái (start/stop)
    socket.on('bot_status_change', function(data) {
        // Cập nhật trạng thái hiển thị
        if(data.status === 'running') {
            botStatusBadge.className = 'badge rounded-pill text-bg-success fs-6 px-3 py-2';
            botStatusBadge.innerHTML = '<i class="fas fa-circle-notch fa-spin me-1"></i> Bot đang hoạt động';
            startBotBtn.disabled = true;
            stopBotBtn.disabled = false;
        } else {
            botStatusBadge.className = 'badge rounded-pill text-bg-secondary fs-6 px-3 py-2';
            botStatusBadge.innerHTML = '<i class="fas fa-stop-circle me-1"></i> Bot đã dừng';
            startBotBtn.disabled = false;
            stopBotBtn.disabled = true;
        }
        
        // Hiển thị thông báo
        showToast('success', data.message);
    });
    
    // Xử lý sự kiện log mới
    socket.on('bot_log', function(logData) {
        // Thêm log mới vào đầu danh sách
        addNewLog(logData);
    });
    
    // Xử lý sự kiện quyết định giao dịch mới
    socket.on('trading_decision', function(decision) {
        // Thêm quyết định mới vào đầu danh sách
        addNewDecision(decision);
    });
    
    // Hàm cập nhật hiển thị trạng thái bot
    function updateBotStatusDisplay(data) {
        if(data.status === 'running') {
            botStatusBadge.className = 'badge rounded-pill text-bg-success fs-6 px-3 py-2';
            botStatusBadge.innerHTML = '<i class="fas fa-circle-notch fa-spin me-1"></i> Bot đang hoạt động';
            startBotBtn.disabled = true;
            stopBotBtn.disabled = false;
        } else {
            botStatusBadge.className = 'badge rounded-pill text-bg-secondary fs-6 px-3 py-2';
            botStatusBadge.innerHTML = '<i class="fas fa-stop-circle me-1"></i> Bot đã dừng';
            startBotBtn.disabled = false;
            stopBotBtn.disabled = true;
        }
        
        // Cập nhật thời gian
        updateLastUpdateTime();
    }
    
    // Hàm cập nhật hiển thị thống kê
    function updateStatsDisplay(stats) {
        uptimeCounter.textContent = stats.uptime;
        analysisCounter.textContent = stats.analyses;
        decisionsCounter.textContent = stats.decisions;
        ordersCounter.textContent = stats.orders;
    }
    
    // Hàm thêm log mới
    function addNewLog(logData) {
        const logTime = new Date(logData.timestamp);
        const formattedTime = logTime.toLocaleTimeString();
        
        const logItem = document.createElement('div');
        logItem.className = `log-item ${logData.category}`;
        logItem.innerHTML = `
            <div class="d-flex justify-content-between">
                <small class="timestamp">${formattedTime}</small>
                <small class="badge ${getCategoryBadgeClass(logData.category)}">${getCategoryLabel(logData.category)}</small>
            </div>
            <div class="mt-1">${logData.message}</div>
        `;
        
        // Nếu container đã có nội dung không phải là thông báo loading
        if (!logContainer.querySelector('.text-center.py-5')) {
            // Thêm phần tử mới vào đầu danh sách
            logContainer.insertBefore(logItem, logContainer.firstChild);
            
            // Nếu có quá nhiều log, xóa bớt
            const logItems = logContainer.querySelectorAll('.log-item');
            if (logItems.length > 50) {
                logContainer.removeChild(logItems[logItems.length - 1]);
            }
        } else {
            // Nếu đang hiển thị loading, xóa nó và thêm log mới
            logContainer.innerHTML = '';
            logContainer.appendChild(logItem);
        }
    }
    
    // Hàm thêm quyết định mới
    function addNewDecision(decision) {
        const decisionTime = new Date(decision.timestamp);
        const formattedTime = decisionTime.toLocaleDateString() + ' ' + decisionTime.toLocaleTimeString();
        
        const decisionItem = document.createElement('div');
        decisionItem.className = `decision-item ${decision.action.toLowerCase()}`;
        
        let decisionContent = `
            <div class="d-flex justify-content-between align-items-start mb-2">
                <h5 class="mb-0">${decision.symbol}: ${getActionLabel(decision.action)}</h5>
                <span class="timestamp">${formattedTime}</span>
            </div>
        `;
        
        // Thêm chi tiết giá nếu có
        if (decision.action !== 'HOLD') {
            decisionContent += `
                <div class="row mb-3">
                    <div class="col-md-4">
                        <div class="text-center">
                            <div class="text-muted small">Giá vào lệnh</div>
                            <div class="fw-bold">${formatPrice(decision.entry_price)}</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center">
                            <div class="text-muted small">Take Profit</div>
                            <div class="fw-bold text-success">${formatPrice(decision.take_profit)}</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center">
                            <div class="text-muted small">Stop Loss</div>
                            <div class="fw-bold text-danger">${formatPrice(decision.stop_loss)}</div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Thêm lý do quyết định
        decisionContent += `<div class="mb-2 fw-bold">Lý do:</div>`;
        decision.reasons.forEach(reason => {
            decisionContent += `<div class="reason-item"><i class="fas fa-check-circle me-1 text-success"></i> ${reason}</div>`;
        });
        
        decisionItem.innerHTML = decisionContent;
        
        // Nếu container đã có nội dung không phải là thông báo loading
        if (!decisionsContainer.querySelector('.text-center.py-5')) {
            // Thêm phần tử mới vào đầu danh sách
            decisionsContainer.insertBefore(decisionItem, decisionsContainer.firstChild);
            
            // Nếu có quá nhiều quyết định, xóa bớt
            const decisionItems = decisionsContainer.querySelectorAll('.decision-item');
            if (decisionItems.length > 5) {
                decisionsContainer.removeChild(decisionItems[decisionItems.length - 1]);
            }
        } else {
            // Nếu đang hiển thị loading, xóa nó và thêm quyết định mới
            decisionsContainer.innerHTML = '';
            decisionsContainer.appendChild(decisionItem);
        }
    }
    
    // Hàm hiển thị thông báo
    function showToast(type, message) {
        if (type === 'success') {
            document.getElementById('toast-message').textContent = message;
            new bootstrap.Toast(document.getElementById('success-toast')).show();
        } else {
            document.getElementById('toast-error-message').textContent = message;
            new bootstrap.Toast(document.getElementById('error-toast')).show();
        }
    }
    // Khởi tạo các biến
    const botSelector = document.getElementById('botSelector');
    const refreshButton = document.getElementById('refreshButton');
    const startBotBtn = document.getElementById('startBotBtn');
    const stopBotBtn = document.getElementById('stopBotBtn');
    const botStatusBadge = document.getElementById('botStatusBadge');
    const lastUpdateTime = document.getElementById('lastUpdateTime');
    
    const refreshLogs = document.getElementById('refreshLogs');
    const refreshDecisions = document.getElementById('refreshDecisions');
    
    const logContainer = document.getElementById('logContainer');
    const decisionsContainer = document.getElementById('decisionsContainer');
    
    const uptimeCounter = document.getElementById('uptimeCounter');
    const analysisCounter = document.getElementById('analysisCounter');
    const decisionsCounter = document.getElementById('decisionsCounter');
    const ordersCounter = document.getElementById('ordersCounter');
    
    // Chức năng tải nhật ký
    function loadLogs() {
        const selectedBot = botSelector.value;
        
        // Hiển thị animation loading
        logContainer.innerHTML = `
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Đang tải nhật ký hoạt động...</p>
            </div>
        `;
        
        // Gọi API để lấy logs
        fetch(`/api/bot/logs?bot_id=${selectedBot}&limit=50`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.logs && data.logs.length > 0) {
                    // Xóa loading và render logs
                    logContainer.innerHTML = '';
                    
                    // Hiển thị logs mới nhất đầu tiên
                    data.logs.forEach(log => {
                        const logTime = new Date(log.timestamp);
                        const formattedTime = logTime.toLocaleTimeString();
                        
                        const logItem = document.createElement('div');
                        logItem.className = `log-item ${log.category}`;
                        logItem.innerHTML = `
                            <div class="d-flex justify-content-between">
                                <small class="timestamp">${formattedTime}</small>
                                <small class="badge ${getCategoryBadgeClass(log.category)}">${getCategoryLabel(log.category)}</small>
                            </div>
                            <div class="mt-1">${log.message}</div>
                        `;
                        
                        logContainer.appendChild(logItem);
                    });
                } else {
                    logContainer.innerHTML = '<div class="text-center py-3">Không có nhật ký hoạt động nào.</div>';
                }
                
                // Cập nhật thời gian
                updateLastUpdateTime();
            })
            .catch(error => {
                console.error('Error loading logs:', error);
                logContainer.innerHTML = '<div class="text-center py-3 text-danger">Đã xảy ra lỗi khi tải nhật ký.</div>';
            });
    }
    
    // Chức năng tải quyết định
    function loadDecisions() {
        const selectedBot = botSelector.value;
        
        // Hiển thị animation loading
        decisionsContainer.innerHTML = `
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Đang tải quyết định giao dịch...</p>
            </div>
        `;
        
        // Gọi API để lấy decisions
        fetch(`/api/bot/decisions?bot_id=${selectedBot}&limit=5`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.decisions && data.decisions.length > 0) {
                    // Xóa loading và render decisions
                    decisionsContainer.innerHTML = '';
                    
                    // Hiển thị decisions mới nhất đầu tiên
                    data.decisions.forEach(decision => {
                        const decisionTime = new Date(decision.timestamp);
                        const formattedTime = decisionTime.toLocaleDateString() + ' ' + decisionTime.toLocaleTimeString();
                        
                        const decisionItem = document.createElement('div');
                        decisionItem.className = `decision-item ${decision.action.toLowerCase()}`;
                        
                        let decisionContent = `
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h5 class="mb-0">${decision.symbol}: ${getActionLabel(decision.action)}</h5>
                                <span class="timestamp">${formattedTime}</span>
                            </div>
                        `;
                        
                        // Thêm chi tiết giá nếu có
                        if (decision.action !== 'HOLD') {
                            decisionContent += `
                                <div class="row mb-3">
                                    <div class="col-md-4">
                                        <div class="text-center">
                                            <div class="text-muted small">Giá vào lệnh</div>
                                            <div class="fw-bold">${formatPrice(decision.entry_price)}</div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="text-center">
                                            <div class="text-muted small">Take Profit</div>
                                            <div class="fw-bold text-success">${formatPrice(decision.take_profit)}</div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="text-center">
                                            <div class="text-muted small">Stop Loss</div>
                                            <div class="fw-bold text-danger">${formatPrice(decision.stop_loss)}</div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }
                        
                        // Thêm lý do quyết định
                        decisionContent += `<div class="mb-2 fw-bold">Lý do:</div>`;
                        decision.reasons.forEach(reason => {
                            decisionContent += `<div class="reason-item"><i class="fas fa-check-circle me-1 text-success"></i> ${reason}</div>`;
                        });
                        
                        decisionItem.innerHTML = decisionContent;
                        decisionsContainer.appendChild(decisionItem);
                    });
                } else {
                    decisionsContainer.innerHTML = '<div class="text-center py-3">Không có quyết định giao dịch nào.</div>';
                }
                
                // Cập nhật thời gian
                updateLastUpdateTime();
            })
            .catch(error => {
                console.error('Error loading decisions:', error);
                decisionsContainer.innerHTML = '<div class="text-center py-3 text-danger">Đã xảy ra lỗi khi tải quyết định giao dịch.</div>';
            });
    }
    
    // Chức năng tải thống kê
    function loadStats() {
        const selectedBot = botSelector.value;
        
        fetch(`/api/bot/stats?bot_id=${selectedBot}`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.stats) {
                    // Cập nhật biến đếm
                    uptimeCounter.textContent = data.stats.uptime;
                    analysisCounter.textContent = data.stats.analyses;
                    decisionsCounter.textContent = data.stats.decisions;
                    ordersCounter.textContent = data.stats.orders;
                }
                
                // Cập nhật thời gian
                updateLastUpdateTime();
            })
            .catch(error => {
                console.error('Error loading stats:', error);
            });
    }
    
    // Chức năng tải trạng thái bot
    function loadBotStatus() {
        fetch('/api/bot/status')
            .then(response => response.json())
            .then(data => {
                // Cập nhật trạng thái
                if (data.status === 'running') {
                    botStatusBadge.className = 'badge rounded-pill text-bg-success fs-6 px-3 py-2';
                    botStatusBadge.innerHTML = '<i class="fas fa-circle-notch fa-spin me-1"></i> Bot đang hoạt động';
                    
                    // Cập nhật trạng thái nút
                    startBotBtn.disabled = true;
                    stopBotBtn.disabled = false;
                } else {
                    botStatusBadge.className = 'badge rounded-pill text-bg-secondary fs-6 px-3 py-2';
                    botStatusBadge.innerHTML = '<i class="fas fa-stop-circle me-1"></i> Bot đã dừng';
                    
                    // Cập nhật trạng thái nút
                    startBotBtn.disabled = false;
                    stopBotBtn.disabled = true;
                }
            })
            .catch(error => {
                console.error('Error loading bot status:', error);
            });
    }
    
    // Hàm cập nhật thời gian
    function updateLastUpdateTime() {
        lastUpdateTime.textContent = new Date().toLocaleTimeString();
    }
    
    // Chuyển đổi danh mục thành badge class
    function getCategoryBadgeClass(category) {
        switch (category) {
            case 'market': return 'bg-info text-white';
            case 'analysis': return 'bg-secondary text-white';
            case 'decision': return 'bg-warning text-dark';
            case 'action': return 'bg-success text-white';
            case 'error': return 'bg-danger text-white';
            default: return 'bg-light text-dark';
        }
    }
    
    // Chuyển đổi danh mục thành nhãn
    function getCategoryLabel(category) {
        switch (category) {
            case 'market': return 'Thị trường';
            case 'analysis': return 'Phân tích';
            case 'decision': return 'Quyết định';
            case 'action': return 'Hành động';
            case 'error': return 'Lỗi';
            default: return category;
        }
    }
    
    // Chuyển đổi hành động thành nhãn
    function getActionLabel(action) {
        switch (action) {
            case 'BUY': return '<span class="badge bg-success">MUA</span>';
            case 'SELL': return '<span class="badge bg-danger">BÁN</span>';
            case 'HOLD': return '<span class="badge bg-warning text-dark">GIỮ</span>';
            default: return action;
        }
    }
    
    // Định dạng giá
    function formatPrice(price) {
        if (!price) return 'N/A';
        return parseFloat(price).toLocaleString(undefined, {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        }) + ' USDT';
    }
    
    // Khởi tạo trang
    function initializePage() {
        loadBotStatus();
        loadLogs();
        loadDecisions();
        loadStats();
    }
    
    // Thiết lập sự kiện
    botSelector.addEventListener('change', function() {
        // Khi bot được chọn thay đổi, tải lại tất cả dữ liệu
        initializePage();
    });
    
    refreshButton.addEventListener('click', function() {
        // Làm mới tất cả dữ liệu
        initializePage();
    });
    
    refreshLogs.addEventListener('click', function() {
        // Chỉ làm mới nhật ký
        loadLogs();
    });
    
    refreshDecisions.addEventListener('click', function() {
        // Chỉ làm mới quyết định
        loadDecisions();
    });
    
    startBotBtn.addEventListener('click', function() {
        const selectedBot = botSelector.value;
        
        // Gửi yêu cầu khởi động bot
        fetch('/api/bot/control/' + selectedBot, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                action: 'start'
            }),
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Hiển thị thông báo thành công
                document.getElementById('toast-message').textContent = 'Bot đã được khởi động thành công!';
                new bootstrap.Toast(document.getElementById('success-toast')).show();
                
                // Cập nhật trạng thái
                loadBotStatus();
            } else {
                // Hiển thị thông báo lỗi
                document.getElementById('toast-error-message').textContent = data.message || 'Không thể khởi động bot!';
                new bootstrap.Toast(document.getElementById('error-toast')).show();
            }
        })
        .catch(error => {
            console.error('Error starting bot:', error);
            document.getElementById('toast-error-message').textContent = 'Đã xảy ra lỗi khi khởi động bot!';
            new bootstrap.Toast(document.getElementById('error-toast')).show();
        });
    });
    
    stopBotBtn.addEventListener('click', function() {
        const selectedBot = botSelector.value;
        
        // Gửi yêu cầu dừng bot
        fetch('/api/bot/control/' + selectedBot, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                action: 'stop'
            }),
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Hiển thị thông báo thành công
                document.getElementById('toast-message').textContent = 'Bot đã được dừng thành công!';
                new bootstrap.Toast(document.getElementById('success-toast')).show();
                
                // Cập nhật trạng thái
                loadBotStatus();
            } else {
                // Hiển thị thông báo lỗi
                document.getElementById('toast-error-message').textContent = data.message || 'Không thể dừng bot!';
                new bootstrap.Toast(document.getElementById('error-toast')).show();
            }
        })
        .catch(error => {
            console.error('Error stopping bot:', error);
            document.getElementById('toast-error-message').textContent = 'Đã xảy ra lỗi khi dừng bot!';
            new bootstrap.Toast(document.getElementById('error-toast')).show();
        });
    });
    
    // Thiết lập intervalpokki
    setInterval(function() {
        // Cập nhật trạng thái bot mỗi 30 giây
        loadBotStatus();
    }, 30000);
    
    // Khởi tạo trang
    initializePage();
});
</script>
{% endblock %}