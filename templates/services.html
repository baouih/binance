{% extends "base.html" %}
{% block title %}Quản lý Dịch vụ{% endblock %}

{% block head %}
{{ super() }}
<style>
  .service-card {
    border-radius: 10px;
    margin-bottom: 20px;
    background-color: #1e2430;
  }
  .service-card .card-header {
    border-bottom: 1px solid #2a3441;
    padding: 15px 20px;
  }
  .service-card .card-body {
    padding: 20px;
  }
  .status-badge {
    font-size: 0.85rem;
    padding: 0.35em 0.65em;
    border-radius: 10px;
  }
  .status-badge-active {
    background-color: #28a745;
    color: white;
  }
  .status-badge-inactive {
    background-color: #dc3545;
    color: white;
  }
  .service-details {
    margin-top: 15px;
    padding: 15px;
    background-color: #171e29;
    border-radius: 8px;
  }
  .service-actions {
    display: flex;
    gap: 10px;
    margin-top: 15px;
  }
  .log-container {
    max-height: 300px;
    overflow-y: auto;
    background-color: #0d1117;
    padding: 10px;
    border-radius: 5px;
    font-family: monospace;
    font-size: 0.85rem;
    margin-top: 20px;
  }
  .subservice-status {
    padding: 5px;
    margin-bottom: 5px;
    border-radius: 5px;
  }
  .subservice-active {
    background-color: rgba(40, 167, 69, 0.1);
    border-left: 3px solid #28a745;
  }
  .subservice-inactive {
    background-color: rgba(220, 53, 69, 0.1);
    border-left: 3px solid #dc3545;
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="row">
    <div class="col-md-12">
      <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-light">Quản lý Dịch vụ</h1>
      </div>
    </div>
  </div>

  <div class="row">
    <!-- Dịch vụ hợp nhất -->
    <div class="col-md-6">
      <div class="service-card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Dịch vụ Hợp nhất</h5>
          <div>
            <span id="status-unified" class="status-badge">Đang kiểm tra...</span>
          </div>
        </div>
        <div class="card-body">
          <p class="text-muted">Dịch vụ này hợp nhất các tiến trình riêng lẻ để tối ưu hóa tài nguyên hệ thống. Bao gồm các dịch vụ: Auto SLTP, Trailing Stop và Theo dõi thị trường.</p>
          
          <div class="service-details">
            <div class="row">
              <div class="col-md-6">
                <p><strong>PID:</strong> <span id="unified-pid">Không có</span></p>
                <p><strong>Trạng thái:</strong> <span id="unified-status">Không hoạt động</span></p>
              </div>
              <div class="col-md-6">
                <p><strong>Thời gian khởi động:</strong> <span id="unified-started-at">-</span></p>
                <p><strong>Lần kiểm tra cuối:</strong> <span id="unified-last-check">-</span></p>
              </div>
            </div>
            
            <h6 class="mt-3">Dịch vụ con:</h6>
            <div id="subservices-container">
              <div class="subservice-status" id="sltp-manager-status">
                <span><i class="fas fa-circle"></i> Auto SLTP Manager: <strong>Không rõ</strong></span>
              </div>
              <div class="subservice-status" id="trailing-stop-status">
                <span><i class="fas fa-circle"></i> Trailing Stop Manager: <strong>Không rõ</strong></span>
              </div>
              <div class="subservice-status" id="market-monitor-status">
                <span><i class="fas fa-circle"></i> Market Monitor: <strong>Không rõ</strong></span>
              </div>
            </div>
          </div>
          
          <div class="service-actions">
            <button id="start-unified-btn" class="btn btn-sm btn-primary"><i class="fas fa-play"></i> Khởi động</button>
            <button id="stop-unified-btn" class="btn btn-sm btn-danger"><i class="fas fa-stop"></i> Dừng lại</button>
            <button id="refresh-unified-btn" class="btn btn-sm btn-info"><i class="fas fa-sync"></i> Làm mới</button>
          </div>
        </div>
      </div>
      
      <!-- Cấu hình dịch vụ hợp nhất -->
      <div class="service-card">
        <div class="card-header">
          <h5 class="mb-0">Cấu hình Dịch vụ</h5>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <h6>Auto SLTP</h6>
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="auto-sltp-enabled" checked>
              <label class="form-check-label" for="auto-sltp-enabled">Bật Auto SLTP</label>
            </div>
            <div class="row mt-2">
              <div class="col-md-6">
                <div class="form-group">
                  <label for="risk-reward-ratio">Tỷ lệ rủi ro/lợi nhuận</label>
                  <input type="number" class="form-control form-control-sm" id="risk-reward-ratio" value="2.0" step="0.1" min="1">
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-group">
                  <label for="stop-loss-percent">Phần trăm Stop Loss</label>
                  <input type="number" class="form-control form-control-sm" id="stop-loss-percent" value="2.0" step="0.1" min="0.1">
                </div>
              </div>
            </div>
          </div>
          
          <div class="mb-3">
            <h6>Trailing Stop</h6>
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="trailing-stop-enabled" checked>
              <label class="form-check-label" for="trailing-stop-enabled">Bật Trailing Stop</label>
            </div>
            <div class="row mt-2">
              <div class="col-md-6">
                <div class="form-group">
                  <label for="activation-percent">Phần trăm kích hoạt</label>
                  <input type="number" class="form-control form-control-sm" id="activation-percent" value="1.0" step="0.1" min="0.1">
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-group">
                  <label for="trailing-percent">Phần trăm theo sau</label>
                  <input type="number" class="form-control form-control-sm" id="trailing-percent" value="0.5" step="0.1" min="0.1">
                </div>
              </div>
            </div>
          </div>
          
          <div class="mb-3">
            <h6>Theo dõi thị trường</h6>
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="market-monitor-enabled" checked>
              <label class="form-check-label" for="market-monitor-enabled">Bật theo dõi thị trường</label>
            </div>
            <div class="row mt-2">
              <div class="col-md-6">
                <div class="form-group">
                  <label for="volatility-threshold">Ngưỡng biến động (%)</label>
                  <input type="number" class="form-control form-control-sm" id="volatility-threshold" value="3.0" step="0.1" min="0.1">
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-group">
                  <label for="check-interval">Khoảng thời gian kiểm tra (giây)</label>
                  <input type="number" class="form-control form-control-sm" id="check-interval" value="60" step="5" min="5">
                </div>
              </div>
            </div>
          </div>
          
          <button id="save-config-btn" class="btn btn-primary"><i class="fas fa-save"></i> Lưu cấu hình</button>
        </div>
      </div>
    </div>
    
    <!-- Nhật ký hoạt động -->
    <div class="col-md-6">
      <div class="service-card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Nhật ký hoạt động</h5>
          <button id="refresh-logs-btn" class="btn btn-sm btn-outline-info"><i class="fas fa-sync"></i> Làm mới</button>
        </div>
        <div class="card-body">
          <div class="log-container" id="log-container">
            <div id="log-content">
              <p class="text-muted">Đang tải nhật ký...</p>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Thông tin hệ thống -->
      <div class="service-card">
        <div class="card-header">
          <h5 class="mb-0">Thông tin hệ thống</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <h6>Tài nguyên</h6>
                <p><strong>CPU:</strong> <span id="cpu-usage">Đang tải...</span></p>
                <p><strong>RAM:</strong> <span id="ram-usage">Đang tải...</span></p>
                <p><strong>Disk:</strong> <span id="disk-usage">Đang tải...</span></p>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <h6>Thời gian hoạt động</h6>
                <p><strong>Hệ thống:</strong> <span id="system-uptime">Đang tải...</span></p>
                <p><strong>Ứng dụng:</strong> <span id="app-uptime">Đang tải...</span></p>
              </div>
            </div>
          </div>
          
          <div class="mb-3">
            <h6>Trạng thái API</h6>
            <p><strong>Binance API:</strong> <span id="api-status" class="badge bg-secondary">Không xác định</span></p>
            <p><strong>Telegram API:</strong> <span id="telegram-status" class="badge bg-secondary">Không xác định</span></p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
  $(document).ready(function() {
    // Lấy trạng thái dịch vụ hợp nhất
    function getUnifiedServiceStatus() {
      $.ajax({
        url: '/api/services/unified/status',
        method: 'GET',
        success: function(data) {
          updateServiceStatus(data);
        },
        error: function(err) {
          console.error('Lỗi khi lấy trạng thái dịch vụ:', err);
          $('#status-unified').text('Lỗi').removeClass().addClass('status-badge status-badge-inactive');
        }
      });
    }
    
    // Cập nhật hiển thị trạng thái dịch vụ
    function updateServiceStatus(data) {
      // Cập nhật trạng thái chính
      if (data.running) {
        $('#status-unified').text('Đang chạy').removeClass().addClass('status-badge status-badge-active');
        $('#unified-status').text('Đang hoạt động');
      } else {
        $('#status-unified').text('Đã dừng').removeClass().addClass('status-badge status-badge-inactive');
        $('#unified-status').text('Không hoạt động');
      }
      
      // Cập nhật thông tin chi tiết
      $('#unified-pid').text(data.pid || 'Không có');
      $('#unified-started-at').text(data.started_at || '-');
      $('#unified-last-check').text(data.last_check || '-');
      
      // Cập nhật trạng thái dịch vụ con
      updateSubserviceStatus('sltp-manager', data.services.sltp_manager);
      updateSubserviceStatus('trailing-stop', data.services.trailing_stop);
      updateSubserviceStatus('market-monitor', data.services.market_monitor);
    }
    
    // Cập nhật hiển thị trạng thái dịch vụ con
    function updateSubserviceStatus(id, serviceData) {
      const element = $(`#${id}-status`);
      if (serviceData && serviceData.active) {
        element.removeClass('subservice-inactive').addClass('subservice-active');
        element.find('strong').text('Đang hoạt động');
        element.find('i').removeClass('fa-circle').addClass('fa-check-circle text-success');
      } else {
        element.removeClass('subservice-active').addClass('subservice-inactive');
        element.find('strong').text('Không hoạt động');
        element.find('i').removeClass('fa-check-circle text-success').addClass('fa-circle text-danger');
      }
    }
    
    // Khởi động dịch vụ hợp nhất
    function startUnifiedService() {
      $('#start-unified-btn').prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> Đang khởi động...');
      
      $.ajax({
        url: '/api/services/unified/start',
        method: 'POST',
        success: function(data) {
          if (data.success) {
            toastr.success(data.message);
            setTimeout(getUnifiedServiceStatus, 2000);
          } else {
            toastr.error(data.message);
          }
          $('#start-unified-btn').prop('disabled', false).html('<i class="fas fa-play"></i> Khởi động');
        },
        error: function(err) {
          console.error('Lỗi khi khởi động dịch vụ:', err);
          toastr.error('Không thể khởi động dịch vụ. Vui lòng kiểm tra log hệ thống.');
          $('#start-unified-btn').prop('disabled', false).html('<i class="fas fa-play"></i> Khởi động');
        }
      });
    }
    
    // Dừng dịch vụ hợp nhất
    function stopUnifiedService() {
      $('#stop-unified-btn').prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> Đang dừng...');
      
      $.ajax({
        url: '/api/services/unified/stop',
        method: 'POST',
        success: function(data) {
          if (data.success) {
            toastr.success(data.message);
            setTimeout(getUnifiedServiceStatus, 2000);
          } else {
            toastr.error(data.message);
          }
          $('#stop-unified-btn').prop('disabled', false).html('<i class="fas fa-stop"></i> Dừng lại');
        },
        error: function(err) {
          console.error('Lỗi khi dừng dịch vụ:', err);
          toastr.error('Không thể dừng dịch vụ. Vui lòng kiểm tra log hệ thống.');
          $('#stop-unified-btn').prop('disabled', false).html('<i class="fas fa-stop"></i> Dừng lại');
        }
      });
    }
    
    // Lấy nhật ký hoạt động
    function getServiceLogs() {
      $('#log-content').html('<p class="text-muted">Đang tải nhật ký...</p>');
      
      $.ajax({
        url: '/api/services/unified/logs',
        method: 'GET',
        success: function(data) {
          if (data.logs && data.logs.length > 0) {
            let logHtml = '';
            data.logs.forEach(function(log) {
              let logClass = '';
              if (log.includes('ERROR')) {
                logClass = 'text-danger';
              } else if (log.includes('WARNING')) {
                logClass = 'text-warning';
              } else if (log.includes('INFO')) {
                logClass = 'text-info';
              }
              logHtml += `<p class="${logClass}">${log}</p>`;
            });
            $('#log-content').html(logHtml);
            // Cuộn xuống cuối
            const logContainer = document.getElementById('log-container');
            logContainer.scrollTop = logContainer.scrollHeight;
          } else {
            $('#log-content').html('<p class="text-muted">Không có nhật ký nào.</p>');
          }
        },
        error: function(err) {
          console.error('Lỗi khi lấy nhật ký:', err);
          $('#log-content').html('<p class="text-danger">Không thể tải nhật ký. Vui lòng thử lại sau.</p>');
        }
      });
    }
    
    // Lấy thông tin hệ thống
    function getSystemInfo() {
      $.ajax({
        url: '/api/system/info',
        method: 'GET',
        success: function(data) {
          $('#cpu-usage').text(data.cpu + '%');
          $('#ram-usage').text(data.memory.used + ' / ' + data.memory.total + ' MB');
          $('#disk-usage').text(data.disk.used + ' / ' + data.disk.total + ' GB');
          $('#system-uptime').text(data.uptime.system);
          $('#app-uptime').text(data.uptime.app);
          
          // Cập nhật trạng thái API
          if (data.api_status.binance) {
            $('#api-status').text('Đang hoạt động').removeClass().addClass('badge bg-success');
          } else {
            $('#api-status').text('Không hoạt động').removeClass().addClass('badge bg-danger');
          }
          
          if (data.api_status.telegram) {
            $('#telegram-status').text('Đang hoạt động').removeClass().addClass('badge bg-success');
          } else {
            $('#telegram-status').text('Không hoạt động').removeClass().addClass('badge bg-danger');
          }
        },
        error: function(err) {
          console.error('Lỗi khi lấy thông tin hệ thống:', err);
        }
      });
    }
    
    // Lấy và hiển thị cấu hình
    function getServiceConfig() {
      $.ajax({
        url: '/api/services/unified/config',
        method: 'GET',
        success: function(data) {
          // Auto SLTP
          $('#auto-sltp-enabled').prop('checked', data.auto_sltp_settings.enabled);
          $('#risk-reward-ratio').val(data.auto_sltp_settings.risk_reward_ratio);
          $('#stop-loss-percent').val(data.auto_sltp_settings.stop_loss_percent);
          
          // Trailing Stop
          $('#trailing-stop-enabled').prop('checked', data.trailing_stop_settings.enabled);
          $('#activation-percent').val(data.trailing_stop_settings.activation_percent);
          $('#trailing-percent').val(data.trailing_stop_settings.trailing_percent);
          
          // Market Monitor
          $('#market-monitor-enabled').prop('checked', data.market_monitor_settings.enabled);
          $('#volatility-threshold').val(data.market_monitor_settings.volatility_threshold);
          $('#check-interval').val(data.market_monitor_settings.check_interval);
        },
        error: function(err) {
          console.error('Lỗi khi lấy cấu hình dịch vụ:', err);
          toastr.error('Không thể tải cấu hình dịch vụ. Vui lòng thử lại sau.');
        }
      });
    }
    
    // Lưu cấu hình dịch vụ
    function saveServiceConfig() {
      const config = {
        auto_sltp_settings: {
          enabled: $('#auto-sltp-enabled').is(':checked'),
          risk_reward_ratio: parseFloat($('#risk-reward-ratio').val()),
          stop_loss_percent: parseFloat($('#stop-loss-percent').val())
        },
        trailing_stop_settings: {
          enabled: $('#trailing-stop-enabled').is(':checked'),
          activation_percent: parseFloat($('#activation-percent').val()),
          trailing_percent: parseFloat($('#trailing-percent').val())
        },
        market_monitor_settings: {
          enabled: $('#market-monitor-enabled').is(':checked'),
          volatility_threshold: parseFloat($('#volatility-threshold').val()),
          check_interval: parseInt($('#check-interval').val())
        }
      };
      
      $('#save-config-btn').prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> Đang lưu...');
      
      $.ajax({
        url: '/api/services/unified/config',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(config),
        success: function(data) {
          if (data.success) {
            toastr.success('Đã lưu cấu hình thành công.');
          } else {
            toastr.error(data.message || 'Không thể lưu cấu hình.');
          }
          $('#save-config-btn').prop('disabled', false).html('<i class="fas fa-save"></i> Lưu cấu hình');
        },
        error: function(err) {
          console.error('Lỗi khi lưu cấu hình:', err);
          toastr.error('Không thể lưu cấu hình. Vui lòng thử lại sau.');
          $('#save-config-btn').prop('disabled', false).html('<i class="fas fa-save"></i> Lưu cấu hình');
        }
      });
    }
    
    // Gắn kết sự kiện cho các nút
    $('#start-unified-btn').click(startUnifiedService);
    $('#stop-unified-btn').click(stopUnifiedService);
    $('#refresh-unified-btn').click(getUnifiedServiceStatus);
    $('#refresh-logs-btn').click(getServiceLogs);
    $('#save-config-btn').click(saveServiceConfig);
    
    // Khởi tạo trang
    getUnifiedServiceStatus();
    getServiceLogs();
    getSystemInfo();
    getServiceConfig();
    
    // Tự động làm mới dữ liệu
    setInterval(getUnifiedServiceStatus, 10000);
    setInterval(getSystemInfo, 30000);
  });
</script>
{% endblock %}