<!DOCTYPE html>
<html lang="vi" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bot Giao Dịch Crypto - Control Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            background-color: #0d1117;
            color: #c9d1d9;
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* Card styles */
        .info-card {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .info-label {
            color: #8b949e;
            font-size: 0.9rem;
        }

        .info-value {
            font-size: 1.2rem;
            font-weight: bold;
        }

        /* Status badges */
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            border-radius: 15px;
            font-weight: bold;
            font-size: 0.8rem;
            margin-right: 10px;
        }

        .status-badge i {
            margin-right: 5px;
        }

        .status-badge.connected {
            background-color: #238636;
            color: white;
        }

        .status-badge.disconnected {
            background-color: #f85149;
            color: white;
        }

        .status-badge.testnet {
            background-color: #fd7e14;
            color: white;
        }

        .status-badge.live {
            background-color: #dc3545;
            color: white;
        }

        /* Messages container */
        .messages-container {
            height: 300px;
            overflow-y: auto;
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 6px;
        }

        .message {
            padding: 10px;
            margin: 5px;
            border-radius: 4px;
            border-left: 4px solid;
        }

        .message-info { border-left-color: #0d6efd; }
        .message-success { border-left-color: #198754; }
        .message-warning { border-left-color: #ffc107; }
        .message-error { border-left-color: #dc3545; }

        .message-time {
            font-size: 0.8em;
            color: #8b949e;
        }

        /* Loading button state */
        .btn-loading {
            position: relative;
            pointer-events: none;
            opacity: 0.7;
        }

        .btn-loading:after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            top: 50%;
            left: 50%;
            margin-top: -8px;
            margin-left: -8px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Tabs */
        .nav-pills .nav-link {
            color: #8b949e;
            background: none;
            border: 1px solid #30363d;
            margin-right: 5px;
        }

        .nav-pills .nav-link.active {
            background-color: #238636;
            border-color: #238636;
            color: white;
        }

        /* Help text */
        .help-text {
            color: #8b949e;
            font-size: 0.9rem;
            margin-top: 5px;
        }

        .alert-testnet {
            background-color: rgba(253, 126, 20, 0.1);
            border-color: #fd7e14;
            color: #fd7e14;
        }

        /* New styles for improved UI */
        .bot-status {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
        }

        .bot-status.running {
            background: rgba(25, 135, 84, 0.1);
            color: #198754;
            border: 1px solid #198754;
        }

        .bot-status.stopped {
            background: rgba(220, 53, 69, 0.1);
            color: #dc3545;
            border: 1px solid #dc3545;
        }


        .notification-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            padding: 0.25rem 0.5rem;
            border-radius: 50%;
            background: #dc3545;
            color: white;
            font-size: 0.75rem;
        }

        .api-guide {
            background: rgba(13, 110, 253, 0.1);
            border: 1px solid #0d6efd;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .api-guide ol {
            margin-bottom: 0;
            padding-left: 20px;
        }

        .info-card.highlight {
            border-color: #198754;
            box-shadow: 0 0 0 1px #198754;
        }

        .testnet-balance {
            font-size: 0.9rem;
            color: #fd7e14;
            margin-top: 5px;
        }

        .btn {
            position: relative;
            transition: all 0.3s ease;
        }

        .btn:active {
            transform: scale(0.95);
        }


        /* Toast notification */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
        }

        .toast {
            background: #323232;
            color: white;
            padding: 15px 25px;
            border-radius: 4px;
            margin-bottom: 10px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .toast.show {
            opacity: 1;
        }

        .btn-success.active {
            background-color: #157347;
            border-color: #146c43;
        }

        .btn-danger.active {
            background-color: #bb2d3b;
            border-color: #b02a37;
        }
        .toast.bg-success {
            background-color: #198754;
        }
        .toast.bg-danger {
            background-color: #dc3545;
        }

        /* Status handling improvements */
        .status-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .connection-status {
            border-radius: 20px;
            padding: 6px 12px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .connection-status.connected {
            background-color: rgba(25, 135, 84, 0.1);
            color: #198754;
            border: 1px solid #198754;
        }

        .connection-status.disconnected {
            background-color: rgba(220, 53, 69, 0.1);
            color: #dc3545;
            border: 1px solid #dc3545;
        }

        /* Button states */
        .btn {
            position: relative;
            transition: all 0.2s ease;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn.loading {
            pointer-events: none;
            opacity: 0.8;
        }

        .btn.loading .spinner-border {
            display: inline-block !important;
        }

        .btn.loading .button-text,
        .btn.loading .bi {
            display: none;
        }

        /* Toast improvements */
        .toast {
            min-width: 300px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

    </style>
</head>
<body>
    <div class="container py-4">
        <!-- Header -->
        <header class="d-flex justify-content-between align-items-center mb-4">
            <div class="d-flex align-items-center">
                <i class="bi bi-currency-bitcoin fs-3 me-2"></i>
                <span class="fs-4">Bot Giao Dịch Crypto</span>
            </div>

            <div class="status-container">
                <!-- Connection Status -->
                <div class="connection-status {{ 'connected' if status.is_connected else 'disconnected' }}">
                    <i class="bi {{ 'bi-wifi' if status.is_connected else 'bi-wifi-off' }}"></i>
                    <span>{{ 'Đã kết nối API' if status.is_connected else 'Chưa kết nối API' }}</span>
                </div>

                <!-- Bot Status -->
                <div class="connection-status {{ 'connected' if status.running else 'disconnected' }}">
                    <i class="bi {{ 'bi-play-circle-fill' if status.running else 'bi-stop-circle-fill' }}"></i>
                    <span>{{ 'Đang chạy' if status.running else 'Đã dừng' }}</span>
                </div>

                <!-- Control Button -->
                <button id="controlButton" type="button"
                        class="btn {{ 'btn-danger' if status.running else 'btn-success' }} btn-lg"
                        {{ 'disabled' if not status.is_connected }}
                        onclick="handleControlButton(this)">
                    <i class="bi {{ 'bi-stop-fill' if status.running else 'bi-play-fill' }} me-2"></i>
                    <span class="button-text">{{ 'Dừng Bot' if status.running else 'Khởi động Bot' }}</span>
                    <div class="spinner-border spinner-border-sm d-none" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </button>
            </div>
        </header>

        <div class="row">
            <!-- Left Column -->
            <div class="col-md-4">
                <div class="info-card">
                    <h5 class="mb-3">Cấu hình Bot</h5>

                    <!-- API Config -->
                    <div class="mb-4">
                        <label class="form-label">Binance API</label>
                        <div class="input-group mb-2">
                            <span class="input-group-text">
                                <i class="bi bi-key"></i>
                            </span>
                            <input type="text" class="form-control" id="apiKey" placeholder="API Key">
                        </div>
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="bi bi-key-fill"></i>
                            </span>
                            <input type="password" class="form-control" id="apiSecret" placeholder="API Secret">
                        </div>
                    </div>

                    <!-- Trade Config -->
                    <div class="mb-4">
                        <label class="form-label">Loại giao dịch</label>
                        <select class="form-select" id="tradingType">
                            <option value="futures">Futures (Đòn bẩy)</option>
                            <option value="spot">Spot (Thông thường)</option>
                        </select>
                    </div>

                    <!-- Risk Config -->
                    <div class="mb-4">
                        <label class="form-label">Mức độ rủi ro</label>
                        <select class="form-select" id="riskLevel">
                            <option value="low">Thấp (2x)</option>
                            <option value="medium" selected>Trung bình (5x)</option>
                            <option value="high">Cao (10x)</option>
                        </select>
                        <div class="mt-3">
                            <div class="alert alert-info">
                                <h6 class="mb-2">Chi tiết mức rủi ro</h6>
                                <div id="riskDetails">
                                    <p class="mb-1"><strong>Đòn bẩy:</strong> 5x</p>
                                    <p class="mb-1"><strong>Rủi ro mỗi lệnh:</strong> 2.5% tài khoản</p>
                                    <p class="mb-1"><strong>Số lệnh tối đa:</strong> 4 lệnh</p>
                                    <p class="mb-0"><strong>Target lợi nhuận:</strong> 2% mỗi ngày</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Save Button -->
                    <div class="text-end">
                        <button id="saveConfigBtn" type="button"
                                class="btn btn-primary btn-lg"
                                onclick="handleSaveConfig(this)">
                            <i class="bi bi-save me-2"></i>
                            <span class="button-text">Lưu cấu hình</span>
                            <div class="spinner-border spinner-border-sm d-none" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div class="col-md-8">
                <!-- Account Info -->
                <div class="info-card mb-4">
                    <h5 class="mb-3">Thông tin tài khoản</h5>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="info-label">Số dư tài khoản</div>
                            <div class="info-value">
                                $<span id="accountBalance">{{ '{:.2f}'.format(account_data.balance|default(0)) }}</span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="info-label">Tiền có thể sử dụng</div>
                            <div class="info-value">
                                $<span id="availableBalance">{{ '{:.2f}'.format(account_data.available|default(0)) }}</span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="info-label">Vị thế mở</div>
                            <div class="info-value" id="openPositions">{{ account_data.positions|length|default(0) }}</div>
                        </div>
                    </div>
                </div>

                <!-- Market Data -->
                <div class="info-card mb-4">
                    <h5 class="mb-3">Thị trường</h5>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="info-label">BTC/USDT</div>
                            <div class="info-value" id="btcPrice">
                                ${{ '{:.2f}'.format(market_data.btc_price|default(0)) }}
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="info-label">ETH/USDT</div>
                            <div class="info-value" id="ethPrice">
                                ${{ '{:.2f}'.format(market_data.eth_price|default(0)) }}
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="info-label">SOL/USDT</div>
                            <div class="info-value" id="solPrice">
                                ${{ '{:.2f}'.format(market_data.sol_price|default(0)) }}
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="info-label">BNB/USDT</div>
                            <div class="info-value" id="bnbPrice">
                                ${{ '{:.2f}'.format(market_data.bnb_price|default(0)) }}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Risk Configuration -->
                <div class="info-card mb-4">
                    <h5 class="mb-3">Cấu hình rủi ro</h5>

                    <!-- Leverage Slider -->
                    <div class="mb-4">
                        <label class="form-label d-flex justify-content-between">
                            <span>Đòn bẩy</span>
                            <span id="leverageValue">x10</span>
                        </label>
                        <input type="range" class="form-range" id="leverage" 
                               min="1" max="100" step="1" value="10">
                        <div class="form-text">
                            Kéo để điều chỉnh đòn bẩy từ x1 đến x100
                        </div>
                    </div>

                    <!-- Account Risk Slider -->
                    <div class="mb-4">
                        <label class="form-label d-flex justify-content-between">
                            <span>Rủi ro mỗi lệnh</span>
                            <span id="riskPerTradeValue">2.5%</span>
                        </label>
                        <input type="range" class="form-range" id="riskPerTrade"
                               min="0.1" max="10" step="0.1" value="2.5">
                        <div class="form-text">
                            % tài khoản tối đa cho mỗi lệnh
                        </div>
                    </div>

                    <!-- Position Limit -->
                    <div class="mb-4">
                        <label class="form-label d-flex justify-content-between">
                            <span>Số lệnh tối đa</span>
                            <span id="maxPositionsValue">4</span>
                        </label>
                        <input type="range" class="form-range" id="maxPositions"
                               min="1" max="10" step="1" value="4">
                    </div>
                </div>

                <!-- System Log -->
                <div class="info-card">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0">Nhật ký hệ thống</h5>
                        <button id="clearLogsBtn" class="btn btn-sm btn-outline-secondary"
                                onclick="clearLogs()">
                            <i class="bi bi-trash me-1"></i>
                            Xóa nhật ký
                        </button>
                    </div>
                    <div class="messages-container" id="messages">
                        {% for message in messages %}
                        <div class="message message-{{ message.level }}">
                            <span class="message-time">{{ message.timestamp }}</span>
                            <div class="message-content">{{ message.content }}</div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>

    <script>
        // Debug logging
        function debugLog(action, data) {
            console.log(`[DEBUG] ${action}:`, data);
        }

        // Elements
        const elements = {
            connectionStatus: document.querySelector('.connection-status'),
            botStatus: document.querySelector('.connection-status:nth-child(2)'),
            controlButton: document.getElementById('controlButton'),
            saveConfigBtn: document.getElementById('saveConfigBtn'),
            leverage: document.getElementById('leverage'),
            leverageValue: document.getElementById('leverageValue'),
            riskPerTrade: document.getElementById('riskPerTrade'),
            riskPerTradeValue: document.getElementById('riskPerTradeValue'),
            maxPositions: document.getElementById('maxPositions'),
            maxPositionsValue: document.getElementById('maxPositionsValue'),
            messagesContainer: document.getElementById('messages')
        };

        // State
        let state = {
            isConnected: {{ 'true' if status.is_connected else 'false' }},
            botRunning: {{ 'true' if status.running else 'false' }},
            reconnectAttempts: 0,
            maxReconnectAttempts: 5
        };

        // Risk Configuration Event Listeners
        elements.leverage.addEventListener('input', (e) => {
            elements.leverageValue.textContent = `x${e.target.value}`;
        });

        elements.riskPerTrade.addEventListener('input', (e) => {
            elements.riskPerTradeValue.textContent = `${e.target.value}%`;
        });

        elements.maxPositions.addEventListener('input', (e) => {
            elements.maxPositionsValue.textContent = e.target.value;
        });

        // Socket setup with improved error handling
        const socket = io({
            reconnection: true,
            reconnectionAttempts: state.maxReconnectAttempts,
            reconnectionDelay: 2000,
            reconnectionDelayMax: 5000,
            timeout: 10000
        });

        // Socket event handlers 
        socket.on('connect', () => {
            debugLog('Socket connected', { reconnectAttempts: state.reconnectAttempts });
            state.isConnected = true;
            state.reconnectAttempts = 0;
            updateConnectionStatus(true);
        });

        socket.on('disconnect', (reason) => {
            debugLog('Socket disconnected', { reason, reconnectAttempts: state.reconnectAttempts });
            state.isConnected = false;

            if (state.reconnectAttempts >= state.maxReconnectAttempts) {
                updateConnectionStatus(false);
                showToast('Mất kết nối tới máy chủ', 'error');
            }
        });

        socket.on('reconnect_attempt', (attempt) => {
            debugLog('Reconnect attempt', { attempt });
            state.reconnectAttempts = attempt;
        });

        socket.on('reconnect_failed', () => {
            debugLog('Reconnect failed');
            showToast('Không thể kết nối lại với máy chủ', 'error');
            updateConnectionStatus(false);
        });

        // Socket data updates
        socket.on('connection_status', (status) => {
            debugLog('Received connection status', status);
            state.isConnected = status.is_connected;
            updateConnectionStatus(status.is_connected);
        });

        socket.on('bot_status_update', (status) => {
            debugLog('Received bot status', status);
            if (status.running !== state.botRunning) {
                state.botRunning = status.running;
                updateBotStatus(status);
            }
        });

        socket.on('account_data', (data) => {
            debugLog('Received account data', data);
            updateAccountData(data);
        });

        socket.on('market_data', (data) => {
            debugLog('Received market data', data);
            updateMarketData(data);
        });

        // UI update functions
        function updateConnectionStatus(connected) {
            if (!elements.connectionStatus) return;

            elements.connectionStatus.className = `connection-status ${connected ? 'connected' : 'disconnected'}`;
            elements.connectionStatus.innerHTML = `
                <i class="bi ${connected ? 'bi-wifi' : 'bi-wifi-off'}"></i>
                <span>${connected ? 'Đã kết nối API' : 'Chưa kết nối API'}</span>
            `;

            elements.controlButton.disabled = !connected;
        }

        function updateBotStatus(status) {
            if (!elements.botStatus) return;

            elements.botStatus.className = `connection-status ${status.running ? 'connected' : 'disconnected'}`;
            elements.botStatus.innerHTML = `
                <i class="bi ${status.running ? 'bi-play-circle-fill' : 'bi-stop-circle-fill'}"></i>
                <span>${status.running ? 'Đang chạy' : 'Đã dừng'}</span>
            `;

            const button = elements.controlButton;
            if (status.running) {
                button.classList.remove('btn-success');
                button.classList.add('btn-danger');
                button.querySelector('.button-text').textContent = 'Dừng Bot';
                button.querySelector('.bi').className = 'bi bi-stop-fill me-2';
            } else {
                button.classList.remove('btn-danger');
                button.classList.add('btn-success');
                button.querySelector('.button-text').textContent = 'Khởi động Bot';
                button.querySelector('.bi').className = 'bi bi-play-fill me-2';
            }
        }

        function setButtonLoading(button, isLoading) {
            debugLog('setButtonLoading', { button: button.id, isLoading });

            const spinner = button.querySelector('.spinner-border');
            const text = button.querySelector('.button-text');
            const icon = button.querySelector('.bi');

            button.disabled = isLoading;
            if (isLoading) {
                spinner.classList.remove('d-none');
                text.classList.add('d-none');
                icon.classList.add('d-none');
                button.classList.add('loading');
            } else {
                spinner.classList.add('d-none');
                text.classList.remove('d-none');
                icon.classList.remove('d-none');
                button.classList.remove('loading');
            }
        }

        // Action handlers
        async function handleControlButton(button) {
            try {
                if (button.disabled || !state.isConnected) {
                    showToast('Vui lòng kết nối API trước khi điều khiển bot', 'error');
                    return;
                }

                const action = state.botRunning ? 'stop' : 'start';
                debugLog('Control button clicked', { action });

                setButtonLoading(button, true);

                const response = await fetch('/api/bot/control', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action })
                });

                const data = await response.json();
                debugLog('Bot control response', data);

                if (data.success) {
                    showToast(
                        action === 'start' ? 'Bot đã được khởi động' : 'Bot đã dừng lại',
                        'success'
                    );
                } else {
                    showToast(`Lỗi: ${data.message}`, 'error');
                }
            } catch (error) {
                debugLog('Bot control error', error);
                showToast(`Lỗi kết nối: ${error.message}`, 'error');
            } finally {
                setTimeout(() => setButtonLoading(button, false), 500);
            }
        }

        async function handleSaveConfig(button) {
            try {
                debugLog('handleSaveConfig', 'start');

                const apiKey = document.getElementById('apiKey').value;
                const apiSecret = document.getElementById('apiSecret').value;
                const leverage = elements.leverage.value;
                const riskPerTrade = elements.riskPerTrade.value;
                const maxPositions = elements.maxPositions.value;

                if (!apiKey || !apiSecret) {
                    showToast('Vui lòng nhập API Key và Secret', 'error');
                    return;
                }

                setButtonLoading(button, true);

                const config = {
                    api_key: apiKey,
                    api_secret: apiSecret,
                    trading_type: document.getElementById('tradingType').value,
                    risk_profile: elements.riskLevel.value,
                    leverage: leverage,
                    risk_per_trade: riskPerTrade,
                    max_positions: maxPositions
                };

                debugLog('Sending config', config);

                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });

                const data = await response.json();
                debugLog('Save config response', data);

                if (data.success) {
                    showToast('Đã lưu cấu hình thành công', 'success');
                    state.isConnected = data.config.is_connected;
                    updateConnectionStatus(state.isConnected);
                } else {
                    showToast(`Lỗi: ${data.message}`, 'error');
                }
            } catch (error) {
                debugLog('Save config error', error);
                showToast(`Lỗi kết nối: ${error.message}`, 'error');
            } finally {
                setTimeout(() => setButtonLoading(button, false), 500);
            }
        }

        function clearLogs() {
            elements.messagesContainer.innerHTML = '';
            addMessage({
                content: 'Đã xóa nhật ký hệ thống',
                level: 'info',
                timestamp: new Date().toLocaleString()
            });
        }

        // Helper functions
        function showToast(message, type = 'success') {
            debugLog('showToast', { message, type });

            const toastContainer = document.querySelector('.toast-container') || (() => {
                const container = document.createElement('div');
                container.className = 'toast-container position-fixed top-0 end-0 p-3';
                document.body.appendChild(container);
                return container;
            })();

            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-white bg-${type === 'error' ? 'danger' : 'success'} border-0`;
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            `;

            toastContainer.appendChild(toast);
            const bsToast = new bootstrap.Toast(toast, { delay: 3000 });
            bsToast.show();

            toast.addEventListener('hidden.bs.toast', () => toast.remove());
        }

        function addMessage(message) {
            const messageHTML = `
                <div class="message message-${message.level}">
                    <span class="message-time">${message.timestamp}</span>
                    <div class="message-content">${message.content}</div>
                </div>
            `;
            elements.messagesContainer.insertAdjacentHTML('beforeend', messageHTML);
            elements.messagesContainer.scrollTop = elements.messagesContainer.scrollHeight;
        }

        function updateAccountData(data) {
            document.getElementById('accountBalance').textContent = data.balance.toFixed(2);
            document.getElementById('availableBalance').textContent = data.available.toFixed(2);
            document.getElementById('openPositions').textContent = data.positions?.length || 0;
        }

        function updateMarketData(data) {
            document.getElementById('btcPrice').textContent = `$${data.btc_price.toFixed(2)}`;
            document.getElementById('ethPrice').textContent = `$${data.eth_price.toFixed(2)}`;
            document.getElementById('solPrice').textContent = `$${data.sol_price.toFixed(2)}`;
            document.getElementById('bnbPrice').textContent = `$${data.bnb_price.toFixed(2)}`;
        }

        // Risk level changes
        elements.riskLevel.addEventListener('change', function() {
            const levels = {
                low: { leverage: 2, riskPerTrade: 1, maxTrades: 10, dailyTarget: 1 },
                medium: { leverage: 5, riskPerTrade: 2.5, maxTrades: 4, dailyTarget: 2 },
                high: { leverage: 10, riskPerTrade: 5, maxTrades: 2, dailyTarget: 3 }
            };

            const level = levels[this.value];
            elements.riskDetails.innerHTML = `
                <p class="mb-1"><strong>Đòn bẩy:</strong> ${level.leverage}x</p>
                <p class="mb-1"><strong>Rủi ro mỗi lệnh:</strong> ${level.riskPerTrade}% tài khoản</p>
                <p class="mb-1"><strong>Số lệnh tối đa:</strong> ${level.maxTrades} lệnh</p>
                <p class="mb-0"><strong>Target lợi nhuận:</strong> ${level.dailyTarget}% mỗi ngày</p>
            `;
        });

        //        // Initialize on load
        window.addEventListener('load', () => {
            elements.messagesContainer.scrollTop = elements.messagesContainer.scrollHeight;
            elements.riskLevel.dispatchEvent(new Event('change'));
            elements.leverage.dispatchEvent(new Event('input'));
            elements.riskPerTrade.dispatchEvent(new Event('input'));
            elements.maxPositions.dispatchEvent(new Event('input'));
        });
    </script>
</body>
</html>