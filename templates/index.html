<!DOCTYPE html>
<html lang="vi" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bot Giao Dịch Crypto - Control Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            background-color: #0d1117;
            color: #c9d1d9;
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* Card styles */
        .info-card {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .info-label {
            color: #8b949e;
            font-size: 0.9rem;
        }

        .info-value {
            font-size: 1.2rem;
            font-weight: bold;
        }

        /* Status badges */
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            border-radius: 15px;
            font-weight: bold;
            font-size: 0.8rem;
            margin-right: 10px;
        }

        .status-badge i {
            margin-right: 5px;
        }
        
        .status-badge.testnet {
            background-color: #ff8800;
            color: #000;
        }

        .status-badge.connected {
            background-color: #238636;
            color: white;
        }

        .status-badge.disconnected {
            background-color: #f85149;
            color: white;
        }

        .status-badge.testnet {
            background-color: #fd7e14;
            color: white;
        }

        .status-badge.live {
            background-color: #dc3545;
            color: white;
        }

        /* Messages container */
        .messages-container {
            height: 300px;
            overflow-y: auto;
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 6px;
        }

        .message {
            padding: 10px;
            margin: 5px;
            border-radius: 6px;
            background-color: rgba(30, 37, 46, 0.8);
            transition: background-color 0.3s ease;
        }
        
        .message:hover {
            background-color: rgba(36, 44, 54, 0.8);
        }
        
        .message-badge {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .message-info { border-left: 2px solid #0d6efd; }
        .message-success { border-left: 2px solid #198754; }
        .message-warning { border-left: 2px solid #ffc107; }
        .message-error { border-left: 2px solid #dc3545; }
        
        .bg-info { background-color: #0d6efd !important; }
        .bg-success { background-color: #198754 !important; }
        .bg-warning { background-color: #ffc107 !important; color: #000 !important; }
        .bg-error { background-color: #dc3545 !important; }

        .message-content {
            font-size: 0.9rem;
            margin-bottom: 3px;
        }

        .message-time {
            font-size: 0.75rem;
            color: #8b949e;
            display: block;
        }

        /* Loading button state */
        .btn-loading {
            position: relative;
            pointer-events: none;
            opacity: 0.7;
        }

        .btn-loading:after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            top: 50%;
            left: 50%;
            margin-top: -8px;
            margin-left: -8px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Tabs */
        .nav-pills .nav-link {
            color: #8b949e;
            background: none;
            border: 1px solid #30363d;
            margin-right: 5px;
        }

        .nav-pills .nav-link.active {
            background-color: #238636;
            border-color: #238636;
            color: white;
        }

        /* Help text */
        .help-text {
            color: #8b949e;
            font-size: 0.9rem;
            margin-top: 5px;
        }

        .alert-testnet {
            background-color: rgba(253, 126, 20, 0.1);
            border-color: #fd7e14;
            color: #fd7e14;
        }

        /* New styles for improved UI */
        .bot-status {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
        }

        .bot-status.running {
            background: rgba(25, 135, 84, 0.1);
            color: #198754;
            border: 1px solid #198754;
        }

        .bot-status.stopped {
            background: rgba(220, 53, 69, 0.1);
            color: #dc3545;
            border: 1px solid #dc3545;
        }


        .notification-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            padding: 0.25rem 0.5rem;
            border-radius: 50%;
            background: #dc3545;
            color: white;
            font-size: 0.75rem;
        }

        .api-guide {
            background: rgba(13, 110, 253, 0.1);
            border: 1px solid #0d6efd;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .api-guide ol {
            margin-bottom: 0;
            padding-left: 20px;
        }

        .info-card.highlight {
            border-color: #198754;
            box-shadow: 0 0 0 1px #198754;
        }

        .testnet-balance {
            font-size: 0.9rem;
            color: #fd7e14;
            margin-top: 5px;
        }

        .btn {
            position: relative;
            transition: all 0.3s ease;
        }

        .btn:active {
            transform: scale(0.95);
        }


        /* Toast notification */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
        }

        .toast {
            background: #323232;
            color: white;
            padding: 15px 25px;
            border-radius: 4px;
            margin-bottom: 10px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .toast.show {
            opacity: 1;
        }

        .btn-success.active {
            background-color: #157347;
            border-color: #146c43;
        }

        .btn-danger.active {
            background-color: #bb2d3b;
            border-color: #b02a37;
        }
        .toast.bg-success {
            background-color: #198754;
        }
        .toast.bg-danger {
            background-color: #dc3545;
        }

        /* Status handling improvements */
        .status-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .connection-status {
            border-radius: 20px;
            padding: 6px 12px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .connection-status.connected {
            background-color: rgba(25, 135, 84, 0.1);
            color: #198754;
            border: 1px solid #198754;
        }

        .connection-status.disconnected {
            background-color: rgba(220, 53, 69, 0.1);
            color: #dc3545;
            border: 1px solid #dc3545;
        }

        /* Button states */
        .btn {
            position: relative;
            transition: all 0.2s ease;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn.loading {
            pointer-events: none;
            opacity: 0.8;
        }

        .btn.loading .spinner-border {
            display: inline-block !important;
        }

        .btn.loading .button-text,
        .btn.loading .bi {
            display: none;
        }

        /* Toast improvements */
        .toast {
            min-width: 300px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        /* Mini chart styles */
        .mini-chart {
            margin-bottom: 5px;
        }
        
        .price-change {
            font-size: 0.85rem;
            font-weight: 500;
            border-radius: 12px;
            padding: 2px 8px;
        }
        
        .price-change.positive {
            background-color: rgba(25, 135, 84, 0.1);
            color: #198754;
        }
        
        .price-change.negative {
            background-color: rgba(220, 53, 69, 0.1);
            color: #dc3545;
        }

    </style>
</head>
<body>
    <div class="container py-4">
        <!-- Header -->
        <header class="d-flex justify-content-between align-items-center mb-4">
            <div class="d-flex align-items-center">
                <i class="bi bi-currency-bitcoin fs-3 me-2"></i>
                <span class="fs-4">Bot Giao Dịch Crypto</span>
            </div>

            <div class="d-flex align-items-center gap-3">
                <!-- Testnet Badge -->
                <div class="status-badge testnet">
                    <i class="bi bi-exclamation-triangle-fill me-1"></i>
                    Testnet
                </div>
                
                <!-- Bot Status -->
                <div class="bot-status {{ 'running' if status.running else 'stopped' }}">
                    <i class="bi {{ 'bi-play-circle-fill' if status.running else 'bi-stop-circle-fill' }} me-2"></i>
                    {{ 'Đang chạy' if status.running else 'Đã dừng' }}
                </div>

                <!-- Control Button -->
                <div class="control-button-wrapper">
                    <button id="controlButton" type="button"
                            class="btn {{ 'btn-danger' if status.running else 'btn-success' }} btn-lg"
                            data-action="{{ 'stop' if status.running else 'start' }}"
                            {{ 'disabled' if not status.is_connected }}>
                        <i class="bi {{ 'bi-stop-fill' if status.running else 'bi-play-fill' }} me-2"></i>
                        {{ 'Dừng Bot' if status.running else 'Khởi động Bot' }}
                    </button>
                </div>
            </div>
        </header>

        <div class="row">
            <!-- Left Column -->
            <div class="col-md-4">
                <div class="info-card">
                    <h5 class="mb-3">Cấu hình Bot</h5>

                    <!-- API Config -->
                    <div class="mb-4">
                        <label class="form-label">Binance API</label>
                        <div class="api-guide mb-3">
                            <h6><i class="bi bi-info-circle me-2"></i>Hướng dẫn kết nối API</h6>
                            <ol>
                                <li>Đăng nhập vào tài khoản <a href="https://testnet.binancefuture.com/" target="_blank">Binance Testnet</a></li>
                                <li>Tạo API key với quyền đọc và giao dịch</li>
                                <li>Sao chép API Key và Secret Key vào form dưới đây</li>
                                <li>Nhấn "Lưu cấu hình" để kết nối</li>
                            </ol>
                            <div class="alert alert-testnet mt-2 mb-0">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                <strong>Lưu ý:</strong> Bot đang chạy ở chế độ Testnet (thử nghiệm). Giao dịch trên Testnet không ảnh hưởng đến tài khoản thật của bạn.
                            </div>
                        </div>
                        
                        <div class="input-group mb-2">
                            <span class="input-group-text">
                                <i class="bi bi-key"></i>
                            </span>
                            <input type="text" class="form-control" id="apiKey" placeholder="API Key">
                        </div>
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="bi bi-key-fill"></i>
                            </span>
                            <input type="password" class="form-control" id="apiSecret" placeholder="API Secret">
                        </div>
                    </div>

                    <!-- Trade Config -->
                    <div class="mb-4">
                        <label class="form-label">Loại giao dịch</label>
                        <select class="form-select" id="tradingType">
                            <option value="futures">Futures (Đòn bẩy)</option>
                            <option value="spot">Spot (Thông thường)</option>
                        </select>
                    </div>

                    <!-- Risk Config -->
                    <div class="mb-4">
                        <label class="form-label">Mức độ rủi ro</label>
                        <select class="form-select" id="riskLevel">
                            <option value="low">Thấp (2x)</option>
                            <option value="medium" selected>Trung bình (5x)</option>
                            <option value="high">Cao (10x)</option>
                        </select>
                        <div class="mt-3">
                            <div class="alert alert-info">
                                <h6 class="mb-2">Chi tiết mức rủi ro</h6>
                                <div id="riskDetails">
                                    <p class="mb-1"><strong>Đòn bẩy:</strong> 5x</p>
                                    <p class="mb-1"><strong>Rủi ro mỗi lệnh:</strong> 2.5% tài khoản</p>
                                    <p class="mb-1"><strong>Số lệnh tối đa:</strong> 4 lệnh</p>
                                    <p class="mb-0"><strong>Target lợi nhuận:</strong> 2% mỗi ngày</p>
                                </div>
                                <hr>
                                <div class="risk-explanation mt-2">
                                    <h6 class="mb-2"><i class="bi bi-shield-exclamation me-1"></i>Hiểu về đòn bẩy & rủi ro</h6>
                                    <ul class="mb-0 ps-3">
                                        <li>Đòn bẩy 5x nghĩa là với $100, bạn có thể giao dịch $500</li>
                                        <li>Rủi ro mỗi lệnh 2.5% nghĩa là mỗi giao dịch chỉ có thể mất tối đa 2.5% tổng số dư của bạn</li>
                                        <li>Đòn bẩy cao hơn = lợi nhuận tiềm năng lớn hơn, NHƯNG rủi ro cũng lớn hơn</li>
                                        <li>Nếu đặt 4 lệnh cùng lúc, rủi ro tối đa là 10% tài khoản</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Save Button -->
                    <div class="text-end">
                        <button id="saveConfigBtn" type="button"
                                class="btn btn-primary btn-lg"
                                onclick="handleSaveConfig(this)">
                            <i class="bi bi-save me-2"></i>
                            <span class="button-text">Lưu cấu hình</span>
                            <div class="spinner-border spinner-border-sm d-none" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div class="col-md-8">
                <!-- Account Info -->
                <div class="info-card mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0">Thông tin tài khoản</h5>
                        <div class="status-badge testnet">
                            <i class="bi bi-currency-exchange me-1"></i>
                            Testnet
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="info-label">Số dư tài khoản</div>
                            <div class="info-value">
                                $<span id="accountBalance">{{ '{:.2f}'.format(account_data.balance|default(0)) }}</span>
                            </div>
                            <div class="testnet-balance mt-1">
                                <i class="bi bi-info-circle-fill me-1"></i>
                                Tài khoản Testnet (thử nghiệm)
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="info-label">Tiền có thể sử dụng</div>
                            <div class="info-value">
                                $<span id="availableBalance">{{ '{:.2f}'.format(account_data.available|default(0)) }}</span>
                            </div>
                            <div class="form-text mt-1">
                                <a href="https://testnet.binancefuture.com/en/futures/BTCUSDT" target="_blank">
                                    <i class="bi bi-arrow-up-right-square me-1"></i>
                                    Nạp tiền Testnet
                                </a>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="info-label">Vị thế mở</div>
                            <div class="info-value" id="openPositions">{{ account_data.positions|length|default(0) }}</div>
                            <div class="form-text mt-1">
                                <a href="#" id="viewPositionsLink">
                                    <i class="bi bi-list-ul me-1"></i>
                                    Xem chi tiết
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Market Data -->
                <div class="info-card mb-4">
                    <h5 class="mb-3">Thị trường</h5>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="info-label">BTC/USDT</div>
                                <div class="price-change positive">+2.5%</div>
                            </div>
                            <div class="d-flex justify-content-between align-items-end">
                                <div class="info-value" id="btcPrice">
                                    ${{ '{:.2f}'.format(market_data.btc_price|default(0)) }}
                                </div>
                                <div class="mini-chart">
                                    <svg width="80" height="30" viewBox="0 0 80 30">
                                        <path d="M0,15 L10,14 L20,18 L30,12 L40,15 L50,9 L60,11 L70,7 L80,5" 
                                            fill="none" stroke="#198754" stroke-width="2"></path>
                                    </svg>
                                </div>
                            </div>
                            <a href="https://testnet.binancefuture.com/en/futures/BTCUSDT" class="btn btn-sm btn-outline-primary w-100 mt-2" target="_blank">
                                <i class="bi bi-graph-up-arrow me-1"></i>
                                Xem biểu đồ
                            </a>
                        </div>
                        <div class="col-md-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="info-label">ETH/USDT</div>
                                <div class="price-change negative">-1.2%</div>
                            </div>
                            <div class="d-flex justify-content-between align-items-end">
                                <div class="info-value" id="ethPrice">
                                    ${{ '{:.2f}'.format(market_data.eth_price|default(0)) }}
                                </div>
                                <div class="mini-chart">
                                    <svg width="80" height="30" viewBox="0 0 80 30">
                                        <path d="M0,10 L10,12 L20,8 L30,14 L40,16 L50,19 L60,17 L70,20 L80,25" 
                                            fill="none" stroke="#dc3545" stroke-width="2"></path>
                                    </svg>
                                </div>
                            </div>
                            <a href="https://testnet.binancefuture.com/en/futures/ETHUSDT" class="btn btn-sm btn-outline-primary w-100 mt-2" target="_blank">
                                <i class="bi bi-graph-up-arrow me-1"></i>
                                Xem biểu đồ
                            </a>
                        </div>
                        <div class="col-md-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="info-label">SOL/USDT</div>
                                <div class="price-change positive">+3.7%</div>
                            </div>
                            <div class="d-flex justify-content-between align-items-end">
                                <div class="info-value" id="solPrice">
                                    ${{ '{:.2f}'.format(market_data.sol_price|default(0)) }}
                                </div>
                                <div class="mini-chart">
                                    <svg width="80" height="30" viewBox="0 0 80 30">
                                        <path d="M0,20 L10,17 L20,15 L30,10 L40,13 L50,8 L60,5 L70,7 L80,3" 
                                            fill="none" stroke="#198754" stroke-width="2"></path>
                                    </svg>
                                </div>
                            </div>
                            <a href="https://testnet.binancefuture.com/en/futures/SOLUSDT" class="btn btn-sm btn-outline-primary w-100 mt-2" target="_blank">
                                <i class="bi bi-graph-up-arrow me-1"></i>
                                Xem biểu đồ
                            </a>
                        </div>
                        <div class="col-md-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="info-label">BNB/USDT</div>
                                <div class="price-change positive">+0.9%</div>
                            </div>
                            <div class="d-flex justify-content-between align-items-end">
                                <div class="info-value" id="bnbPrice">
                                    ${{ '{:.2f}'.format(market_data.bnb_price|default(0)) }}
                                </div>
                                <div class="mini-chart">
                                    <svg width="80" height="30" viewBox="0 0 80 30">
                                        <path d="M0,15 L10,14 L20,16 L30,13 L40,14 L50,12 L60,10 L70,11 L80,9" 
                                            fill="none" stroke="#198754" stroke-width="2"></path>
                                    </svg>
                                </div>
                            </div>
                            <a href="https://testnet.binancefuture.com/en/futures/BNBUSDT" class="btn btn-sm btn-outline-primary w-100 mt-2" target="_blank">
                                <i class="bi bi-graph-up-arrow me-1"></i>
                                Xem biểu đồ
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Risk Configuration -->
                <div class="info-card mb-4">
                    <h5 class="mb-3">Cấu hình rủi ro</h5>

                    <!-- Leverage Slider -->
                    <div class="mb-4">
                        <label class="form-label d-flex justify-content-between">
                            <span>Đòn bẩy</span>
                            <span id="leverageValue">x10</span>
                        </label>
                        <input type="range" class="form-range" id="leverage"
                               min="1" max="100" step="1" value="10">
                        <div class="form-text">
                            Kéo để điều chỉnh đòn bẩy từ x1 đến x100
                        </div>
                    </div>

                    <!-- Account Risk Slider -->
                    <div class="mb-4">
                        <label class="form-label d-flex justify-content-between">
                            <span>Rủi ro mỗi lệnh</span>
                            <span id="riskPerTradeValue">2.5%</span>
                        </label>
                        <input type="range" class="form-range" id="riskPerTrade"
                               min="0.1" max="10" step="0.1" value="2.5">
                        <div class="form-text">
                            % tài khoản tối đa cho mỗi lệnh
                        </div>
                    </div>

                    <!-- Position Limit -->
                    <div class="mb-4">
                        <label class="form-label d-flex justify-content-between">
                            <span>Số lệnh tối đa</span>
                            <span id="maxPositionsValue">4</span>
                        </label>
                        <input type="range" class="form-range" id="maxPositions"
                               min="1" max="10" step="1" value="4">
                    </div>
                </div>

                <!-- System Log -->
                <div class="info-card">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0 d-flex align-items-center">
                            <i class="bi bi-journal-text me-2"></i>
                            Nhật ký hệ thống
                            <span class="badge bg-secondary rounded-pill ms-2" id="logCount">{{ messages|length }}</span>
                        </h5>
                        <div>
                            <button id="filterLogsBtn" class="btn btn-sm btn-outline-primary me-2" 
                                    data-bs-toggle="dropdown">
                                <i class="bi bi-funnel me-1"></i>
                                Lọc
                            </button>
                            <div class="dropdown-menu p-2">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="showInfoLogs" checked>
                                    <label class="form-check-label" for="showInfoLogs">
                                        <span class="badge bg-primary">Thông tin</span>
                                    </label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="showSuccessLogs" checked>
                                    <label class="form-check-label" for="showSuccessLogs">
                                        <span class="badge bg-success">Thành công</span>
                                    </label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="showWarningLogs" checked>
                                    <label class="form-check-label" for="showWarningLogs">
                                        <span class="badge bg-warning text-dark">Cảnh báo</span>
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="showErrorLogs" checked>
                                    <label class="form-check-label" for="showErrorLogs">
                                        <span class="badge bg-danger">Lỗi</span>
                                    </label>
                                </div>
                            </div>
                            
                            <button id="clearLogsBtn" class="btn btn-sm btn-outline-secondary"
                                    onclick="clearLogs()">
                                <i class="bi bi-trash me-1"></i>
                                Xóa nhật ký
                            </button>
                        </div>
                    </div>
                    <div class="messages-container" id="messages">
                        {% for message in messages %}
                        <div class="message message-{{ message.level }}">
                            <div class="d-flex">
                                <span class="message-badge badge me-2 bg-{{ message.level }}">
                                    <i class="bi {{ 'bi-info-circle' if message.level == 'info' 
                                                  else ('bi-check-circle' if message.level == 'success'
                                                  else ('bi-exclamation-triangle' if message.level == 'warning'
                                                  else 'bi-x-circle')) }}"></i>
                                </span>
                                <div class="flex-grow-1">
                                    <div class="message-content">{{ message.content }}</div>
                                    <span class="message-time">{{ message.timestamp }}</span>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>

    <script>
        // Debug logging
        function debugLog(action, data) {
            console.log(`[DEBUG] ${action}:`, data);
        }

        // Elements
        const elements = {
            connectionStatus: document.querySelector('.connection-status'),
            botStatus: document.querySelector('.bot-status'),
            controlButton: document.getElementById('controlButton'),
            saveConfigBtn: document.getElementById('saveConfigBtn'),
            leverage: document.getElementById('leverage'),
            leverageValue: document.getElementById('leverageValue'),
            riskPerTrade: document.getElementById('riskPerTrade'),
            riskPerTradeValue: document.getElementById('riskPerTradeValue'),
            maxPositions: document.getElementById('maxPositions'),
            maxPositionsValue: document.getElementById('maxPositionsValue'),
            messagesContainer: document.getElementById('messages'),
            riskLevel: document.getElementById('riskLevel'),
            riskDetails: document.getElementById('riskDetails')
        };

        // State
        let state = {
            isConnected: {{ 'true' if status.is_connected else 'false' }},
            botRunning: {{ 'true' if status.running else 'false' }},
            reconnectAttempts: 0,
            maxReconnectAttempts: 5
        };

        // Risk Configuration Event Listeners
        elements.leverage.addEventListener('input', (e) => {
            elements.leverageValue.textContent = `x${e.target.value}`;
        });

        elements.riskPerTrade.addEventListener('input', (e) => {
            elements.riskPerTradeValue.textContent = `${e.target.value}%`;
        });

        elements.maxPositions.addEventListener('input', (e) => {
            elements.maxPositionsValue.textContent = e.target.value;
        });

        // Socket setup with improved error handling
        const socket = io({
            reconnection: true,
            reconnectionAttempts: state.maxReconnectAttempts,
            reconnectionDelay: 2000,
            reconnectionDelayMax: 5000,
            timeout: 10000
        });

        // Socket event handlers
        socket.on('connect', () => {
            debugLog('Socket connected', { reconnectAttempts: state.reconnectAttempts });
            state.isConnected = true;
            state.reconnectAttempts = 0;
            updateConnectionStatus(true);
        });

        socket.on('disconnect', (reason) => {
            debugLog('Socket disconnected', { reason, reconnectAttempts: state.reconnectAttempts });
            state.isConnected = false;

            if (state.reconnectAttempts >= state.maxReconnectAttempts) {
                updateConnectionStatus(false);
                showToast('Mất kết nối tới máy chủ', 'error');
            }
        });

        socket.on('reconnect_attempt', (attempt) => {
            debugLog('Reconnect attempt', { attempt });
            state.reconnectAttempts = attempt;
        });

        socket.on('reconnect_failed', () => {
            debugLog('Reconnect failed');
            showToast('Không thể kết nối lại với máy chủ', 'error');
            updateConnectionStatus(false);
        });

        // Socket data updates
        socket.on('connection_status', (status) => {
            debugLog('Received connection status', status);
            state.isConnected = status.is_connected;
            updateConnectionStatus(status.is_connected);
        });

        socket.on('bot_status_update', (status) => {
            debugLog('Received bot status', status);
            state.botRunning = status.running;
            updateBotStatus(status);
        });

        socket.on('account_data', (data) => {
            debugLog('Received account data', data);
            updateAccountData(data);
        });

        socket.on('market_data', (data) => {
            debugLog('Received market data', data);
            updateMarketData(data);
        });
        
        socket.on('new_message', (message) => {
            debugLog('Received new message', message);
            addMessage(message);
            
            // Kiểm tra nếu là thông báo giao dịch mới
            if (message.content.includes('Lệnh mới') || message.content.includes('Đã mở vị thế')) {
                notifyNewTrade(message);
                document.getElementById('logCount').textContent = parseInt(document.getElementById('logCount').textContent || '0') + 1;
            }
        });
        
        socket.on('new_trade', (trade) => {
            debugLog('Received new trade', trade);
            notifyNewTrade({
                content: `Lệnh mới: ${trade.symbol} ${trade.side} tại $${trade.entry_price}`,
                level: 'success',
                timestamp: new Date().toLocaleString()
            });
        });

        // UI update functions
        function updateConnectionStatus(connected) {
            if (!elements.connectionStatus) return;

            elements.connectionStatus.className = `connection-status ${connected ? 'connected' : 'disconnected'}`;
            elements.connectionStatus.innerHTML = `
                <i class="bi ${connected ? 'bi-wifi' : 'bi-wifi-off'}"></i>
                <span>${connected ? 'Đã kết nối API' : 'Chưa kết nối API'}</span>
            `;

            elements.controlButton.disabled = !connected;
        }


        function setButtonLoading(button, isLoading) {
            debugLog('setButtonLoading', { button: button.id, isLoading });

            const spinner = button.querySelector('.spinner-border');
            const text = button.querySelector('.button-text');
            const icon = button.querySelector('.bi');

            button.disabled = isLoading;
            if (isLoading) {
                spinner.classList.remove('d-none');
                text.classList.add('d-none');
                icon.classList.add('d-none');
                button.classList.add('loading');
            } else {
                spinner.classList.add('d-none');
                text.classList.remove('d-none');
                icon.classList.remove('d-none');
                button.classList.remove('loading');
            }
        }

        // Action handlers
        async function handleControlButton() {
            // Debug
            console.log('handleControlButton được gọi!');
            
            const button = document.getElementById('controlButton');
            console.log('Button text:', button.textContent);
            
            const botStatus = document.querySelector('.bot-status');
            if (!botStatus) console.log('Không tìm thấy element botStatus');

            if (button.disabled) {
                console.log('Button đang disabled, không thực hiện thao tác');
                return;
            }

            button.disabled = true;
            console.log('Button đã disabled trong quá trình xử lý');

            try {
                const action = button.textContent.includes('Dừng') ? 'stop' : 'start';
                console.log('Hành động:', action);

                console.log('Gửi request đến /api/bot/control với action =', action);
                showToast('Đang ' + (action === 'start' ? 'khởi động' : 'dừng') + ' bot...', 'info');
                
                const response = await fetch('/api/bot/control', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({action})
                });

                const data = await response.json();

                if (data.success) {
                    if (action === 'start') {
                        button.classList.remove('btn-success');
                        button.classList.add('btn-danger');
                        button.innerHTML = '<i class="bi bi-stop-fill me-2"></i>Dừng Bot';

                        botStatus.classList.remove('stopped');
                        botStatus.classList.add('running');
                        botStatus.innerHTML = '<i class="bi bi-play-circle-fill me-2"></i>Đang chạy';
                    } else {
                        button.classList.remove('btn-danger');
                        button.classList.add('btn-success');
                        button.innerHTML = '<i class="bi bi-play-fill me-2"></i>Khởi động Bot';

                        botStatus.classList.remove('running');
                        botStatus.classList.add('stopped');
                        botStatus.innerHTML = '<i class="bi bi-stop-circle-fill me-2"></i>Đã dừng';
                    }

                    showToast(action === 'start' ? 'Bot đã được khởi động' : 'Bot đã dừng lại', 'success');
                } else {
                    showToast(`Lỗi: ${data.message}`, 'error');
                }
            } catch (error) {
                showToast('Lỗi kết nối tới máy chủ', 'error');
            } finally {
                button.disabled = false;
            }
        }

        async function handleSaveConfig(button) {
            try {
                debugLog('handleSaveConfig', 'start');

                const apiKey = document.getElementById('apiKey').value;
                const apiSecret = document.getElementById('apiSecret').value;
                const leverage = elements.leverage.value;
                const riskPerTrade = elements.riskPerTrade.value;
                const maxPositions = elements.maxPositions.value;

                if (!apiKey || !apiSecret) {
                    showToast('Vui lòng nhập API Key và Secret', 'error');
                    return;
                }

                setButtonLoading(button, true);

                const config = {
                    api_key: apiKey,
                    api_secret: apiSecret,
                    trading_type: document.getElementById('tradingType').value,
                    risk_profile: elements.riskLevel.value,
                    leverage: leverage,
                    risk_per_trade: riskPerTrade,
                    max_positions: maxPositions
                };

                debugLog('Sending config', config);

                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });

                const data = await response.json();
                debugLog('Save config response', data);

                if (data.success) {
                    showToast('Đã lưu cấu hình thành công', 'success');
                    state.isConnected = data.config.is_connected;
                    updateConnectionStatus(state.isConnected);
                } else {
                    showToast(`Lỗi: ${data.message}`, 'error');
                }
            } catch (error) {
                debugLog('Save config error', error);
                showToast(`Lỗi kết nối: ${error.message}`, 'error');
            } finally {
                setTimeout(() => setButtonLoading(button, false), 500);
            }
        }

        function clearLogs() {
            elements.messagesContainer.innerHTML = '';
            addMessage({
                content: 'Đã xóa nhật ký hệ thống',
                level: 'info',
                timestamp: new Date().toLocaleString()
            });
        }

        // Helper functions
        function showToast(message, type = 'success') {
            debugLog('showToast', { message, type });

            const toastContainer = document.querySelector('.toast-container') || (() => {
                const container = document.createElement('div');
                container.className = 'toast-container position-fixed top-0 end-0 p-3';
                document.body.appendChild(container);
                return container;
            })();

            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-white bg-${type === 'error' ? 'danger' : 'success'} border-0`;
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            `;

            toastContainer.appendChild(toast);
            const bsToast = new bootstrap.Toast(toast, { delay: 3000 });
            bsToast.show();

            toast.addEventListener('hidden.bs.toast', () => toast.remove());
        }

        function addMessage(message) {
            const messageHTML = `
                <div class="message message-${message.level}">
                    <div class="d-flex">
                        <span class="message-badge badge me-2 bg-${message.level}">
                            <i class="bi ${message.level === 'info' 
                                ? 'bi-info-circle' 
                                : (message.level === 'success'
                                   ? 'bi-check-circle' 
                                   : (message.level === 'warning'
                                     ? 'bi-exclamation-triangle'
                                     : 'bi-x-circle'))}"></i>
                        </span>
                        <div class="flex-grow-1">
                            <div class="message-content">${message.content}</div>
                            <span class="message-time">${message.timestamp}</span>
                        </div>
                    </div>
                </div>
            `;
            elements.messagesContainer.insertAdjacentHTML('beforeend', messageHTML);
            elements.messagesContainer.scrollTop = elements.messagesContainer.scrollHeight;
        }

        function updateAccountData(data) {
            document.getElementById('accountBalance').textContent = data.balance.toFixed(2);
            document.getElementById('availableBalance').textContent = data.available.toFixed(2);
            document.getElementById('openPositions').textContent = data.positions?.length || 0;
        }

        function updateMarketData(data) {
            document.getElementById('btcPrice').textContent = `$${data.btc_price.toFixed(2)}`;
            document.getElementById('ethPrice').textContent = `$${data.eth_price.toFixed(2)}`;
            document.getElementById('solPrice').textContent = `$${data.sol_price.toFixed(2)}`;
            document.getElementById('bnbPrice').textContent = `$${data.bnb_price.toFixed(2)}`;
        }
        
        function notifyNewTrade(message) {
            // Thêm thông báo âm thanh khi có giao dịch mới
            const audio = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3');
            audio.volume = 0.5;
            audio.play().catch(e => console.log('Không thể phát âm thanh thông báo:', e));
            
            // Hiển thị thông báo desktop nếu được hỗ trợ
            if ("Notification" in window && Notification.permission === "granted") {
                new Notification("Giao dịch mới", {
                    body: message.content,
                    icon: "https://cdn-icons-png.flaticon.com/512/5499/5499403.png"
                });
            } else if ("Notification" in window && Notification.permission !== "denied") {
                Notification.requestPermission().then(permission => {
                    if (permission === "granted") {
                        new Notification("Giao dịch mới", {
                            body: message.content,
                            icon: "https://cdn-icons-png.flaticon.com/512/5499/5499403.png"
                        });
                    }
                });
            }
            
            // Hiển thị thông báo trong ứng dụng
            showToast(message.content, 'success');
        }

        // Risk level changes
        elements.riskLevel.addEventListener('change', function() {
            const levels = {
                low: { leverage: 2, riskPerTrade: 1, maxTrades: 10, dailyTarget: 1 },
                medium: { leverage: 5, riskPerTrade: 2.5, maxTrades: 4, dailyTarget: 2 },
                high: { leverage: 10, riskPerTrade: 5, maxTrades: 2, dailyTarget: 3 }
            };

            const level = levels[this.value];
            elements.riskDetails.innerHTML = `
                <p class="mb-1"><strong>Đòn bẩy:</strong> ${level.leverage}x</p>
                <p class="mb-1"><strong>Rủi ro mỗi lệnh:</strong> ${level.riskPerTrade}% tài khoản</p>
                <p class="mb-1"><strong>Số lệnh tối đa:</strong> ${level.maxTrades} lệnh</p>
                <p class="mb-0"><strong>Target lợi nhuận:</strong> ${level.dailyTarget}% mỗi ngày</p>
            `;
        });

        // Filter logs
        document.getElementById('showInfoLogs').addEventListener('change', filterLogs);
        document.getElementById('showSuccessLogs').addEventListener('change', filterLogs);
        document.getElementById('showWarningLogs').addEventListener('change', filterLogs);
        document.getElementById('showErrorLogs').addEventListener('change', filterLogs);
        
        function filterLogs() {
            const showInfo = document.getElementById('showInfoLogs').checked;
            const showSuccess = document.getElementById('showSuccessLogs').checked;
            const showWarning = document.getElementById('showWarningLogs').checked;
            const showError = document.getElementById('showErrorLogs').checked;
            
            const messages = elements.messagesContainer.querySelectorAll('.message');
            
            messages.forEach(message => {
                if (message.classList.contains('message-info')) {
                    message.style.display = showInfo ? 'block' : 'none';
                } else if (message.classList.contains('message-success')) {
                    message.style.display = showSuccess ? 'block' : 'none';
                } else if (message.classList.contains('message-warning')) {
                    message.style.display = showWarning ? 'block' : 'none';
                } else if (message.classList.contains('message-error')) {
                    message.style.display = showError ? 'block' : 'none';
                }
            });
        }
        
        // Initialize on load
        window.addEventListener('load', () => {
            // Yêu cầu quyền thông báo
            if ("Notification" in window && Notification.permission !== "granted" && Notification.permission !== "denied") {
                Notification.requestPermission();
            }
            
            // Khởi tạo giao diện
            elements.messagesContainer.scrollTop = elements.messagesContainer.scrollHeight;
            elements.riskLevel.dispatchEvent(new Event('change'));
            elements.leverage.dispatchEvent(new Event('input'));
            elements.riskPerTrade.dispatchEvent(new Event('input'));
            elements.maxPositions.dispatchEvent(new Event('input'));
            
            // Thêm sự kiện xem chi tiết vị thế
            document.getElementById('viewPositionsLink').addEventListener('click', function(e) {
                e.preventDefault();
                // Đây sẽ là nơi mở modal hiển thị chi tiết vị thế
                showToast('Tính năng này đang được phát triển', 'info');
            });
            
            // Fix: Thêm event listener trực tiếp cho nút khởi động bot và wrapper
            const controlButton = document.getElementById('controlButton');
            const buttonWrapper = document.querySelector('.control-button-wrapper');
            
            if (controlButton) {
                console.log('Đã tìm thấy nút điều khiển bot, thêm event listener');
                
                // Xóa event click cũ (nếu có)
                controlButton.onclick = null;
                
                // Tạo hàm xử lý riêng cho nút
                const handleBotControl = function(e) {
                    if (e) {
                        e.preventDefault();
                        e.stopPropagation();
                    }
                    console.log('Đã gọi hàm xử lý nút điều khiển bot');
                    
                    // Xử lý trực tiếp thay vì gọi handleControlButton()
                    const button = document.getElementById('controlButton');
                    if (!button || button.disabled) {
                        console.log('Nút không tồn tại hoặc đang bị disabled');
                        return;
                    }
                    
                    button.disabled = true;
                    console.log('Button đã disabled trong quá trình xử lý');

                    try {
                        const action = button.getAttribute('data-action') || (button.textContent.includes('Dừng') ? 'stop' : 'start');
                        console.log('Hành động:', action);

                        console.log('Gửi request đến /api/bot/control với action =', action);
                        showToast('Đang ' + (action === 'start' ? 'khởi động' : 'dừng') + ' bot...', 'info');
                        
                        // Sử dụng XHR thay vì fetch để kiểm tra vấn đề
                        const xhr = new XMLHttpRequest();
                        xhr.open('POST', '/api/bot/control', true);
                        xhr.setRequestHeader('Content-Type', 'application/json');
                        xhr.onload = function() {
                            if (xhr.status >= 200 && xhr.status < 300) {
                                const data = JSON.parse(xhr.responseText);
                                if (data.success) {
                                    if (action === 'start') {
                                        button.classList.remove('btn-success');
                                        button.classList.add('btn-danger');
                                        button.innerHTML = '<i class="bi bi-stop-fill me-2"></i>Dừng Bot';
                                        button.setAttribute('data-action', 'stop');

                                        const botStatus = document.querySelector('.bot-status');
                                        if (botStatus) {
                                            botStatus.classList.remove('stopped');
                                            botStatus.classList.add('running');
                                            botStatus.innerHTML = '<i class="bi bi-play-circle-fill me-2"></i>Đang chạy';
                                        }
                                    } else {
                                        button.classList.remove('btn-danger');
                                        button.classList.add('btn-success');
                                        button.innerHTML = '<i class="bi bi-play-fill me-2"></i>Khởi động Bot';
                                        button.setAttribute('data-action', 'start');

                                        const botStatus = document.querySelector('.bot-status');
                                        if (botStatus) {
                                            botStatus.classList.remove('running');
                                            botStatus.classList.add('stopped');
                                            botStatus.innerHTML = '<i class="bi bi-stop-circle-fill me-2"></i>Đã dừng';
                                        }
                                    }

                                    showToast(action === 'start' ? 'Bot đã được khởi động' : 'Bot đã dừng lại', 'success');
                                } else {
                                    showToast(`Lỗi: ${data.message}`, 'error');
                                }
                            } else {
                                showToast('Lỗi kết nối tới máy chủ: ' + xhr.status, 'error');
                            }
                            button.disabled = false;
                        };
                        xhr.onerror = function() {
                            showToast('Lỗi kết nối tới máy chủ', 'error');
                            button.disabled = false;
                        };
                        xhr.send(JSON.stringify({action}));
                    } catch (error) {
                        console.error('Lỗi khi xử lý nút:', error);
                        showToast('Lỗi kết nối tới máy chủ', 'error');
                        button.disabled = false;
                    }
                };
                
                // Thêm sự kiện cho button
                controlButton.addEventListener('click', handleBotControl);
                controlButton.addEventListener('touchend', handleBotControl);
                
                // Thêm sự kiện cho wrapper
                if (buttonWrapper) {
                    console.log('Đã tìm thấy wrapper cho nút, thêm event listener');
                    buttonWrapper.addEventListener('click', handleBotControl);
                    buttonWrapper.addEventListener('touchend', handleBotControl);
                }
                
                // Thêm nút khởi động bot cố định ở góc màn hình cho thiết bị di động
                if (window.innerWidth <= 768) {
                    const floatingButton = document.createElement('div');
                    floatingButton.className = 'floating-control-button';
                    floatingButton.innerHTML = controlButton.getAttribute('data-action') === 'stop' ?
                        '<i class="bi bi-stop-fill"></i>' : '<i class="bi bi-play-fill"></i>';
                    
                    floatingButton.addEventListener('click', handleBotControl);
                    floatingButton.addEventListener('touchend', handleBotControl);
                    
                    document.body.appendChild(floatingButton);
                    console.log('Đã thêm nút điều khiển nổi cho thiết bị di động');
                }
            } else {
                console.error('Không tìm thấy nút điều khiển bot với id "controlButton"');
            }
        });
    </script>
</body>
</html>