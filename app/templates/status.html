<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trạng Thái Hệ Thống</title>
    <link rel="stylesheet" href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css">
    <style>
        .status-indicator {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 10px;
        }
        .status-active {
            background-color: #4caf50;
            box-shadow: 0 0 10px #4caf50;
        }
        .status-inactive {
            background-color: #f44336;
            box-shadow: 0 0 10px #f44336;
        }
        .status-warning {
            background-color: #ff9800;
            box-shadow: 0 0 10px #ff9800;
        }
        .status-offline {
            background-color: #9e9e9e;
        }
        pre {
            background-color: #333;
            padding: 15px;
            border-radius: 5px;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>Trạng Thái Hệ Thống</h1>
            <div>
                <button id="refresh-btn" class="btn btn-primary">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-clockwise" viewBox="0 0 16 16">
                        <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/>
                        <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/>
                    </svg>
                    Làm mới
                </button>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-6">
                <div class="card mb-4">
                    <div class="card-header">
                        <h4>Dịch Vụ</h4>
                    </div>
                    <div class="card-body">
                        <table class="table table-hover">
                            <tbody>
                                <tr>
                                    <td width="200">Web Server</td>
                                    <td><span class="status-indicator status-active"></span> Hoạt động</td>
                                </tr>
                                <tr id="socket-status-row">
                                    <td>Socket.IO</td>
                                    <td><span class="status-indicator status-offline"></span> Đang kiểm tra...</td>
                                </tr>
                                <tr>
                                    <td>Binance API</td>
                                    <td><span class="status-indicator status-warning"></span> Mô phỏng</td>
                                </tr>
                                <tr>
                                    <td>Bot Giao Dịch</td>
                                    <td><span class="status-indicator status-inactive"></span> Không hoạt động</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="card mb-4">
                    <div class="card-header">
                        <h4>Môi Trường</h4>
                    </div>
                    <div class="card-body">
                        <table class="table">
                            <tbody id="env-info">
                                <tr>
                                    <td width="200">Flask</td>
                                    <td>Đang tải...</td>
                                </tr>
                                <tr>
                                    <td>Python</td>
                                    <td>Đang tải...</td>
                                </tr>
                                <tr>
                                    <td>Chế độ</td>
                                    <td>Mô phỏng</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-6">
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h4>Giá Hiện Tại</h4>
                        <span id="price-update-time" class="badge bg-secondary">Cập nhật: --:--:--</span>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6">
                                <div class="card bg-dark">
                                    <div class="card-body text-center">
                                        <h6>BTC/USDT</h6>
                                        <h3 id="btc-price">61,245.80</h3>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="card bg-dark">
                                    <div class="card-body text-center">
                                        <h6>ETH/USDT</h6>
                                        <h3 id="eth-price">3,125.45</h3>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card mb-4">
                    <div class="card-header">
                        <h4>Nhật Ký Hệ Thống</h4>
                    </div>
                    <div class="card-body">
                        <div class="d-flex mb-3">
                            <select id="log-type" class="form-select me-2">
                                <option value="system">Hệ thống</option>
                                <option value="trading">Giao dịch</option>
                                <option value="socket">Socket</option>
                            </select>
                            <button id="clear-log" class="btn btn-outline-secondary">Xóa</button>
                        </div>
                        
                        <pre id="log-content">Đang tải nhật ký...</pre>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="text-center mb-5 mt-4">
            <a href="/" class="btn btn-lg btn-outline-secondary me-3">Trang Chủ</a>
            <a href="/minimal" class="btn btn-lg btn-outline-primary me-3">Kiểm Tra Tối Giản</a>
            <a href="/test" class="btn btn-lg btn-outline-info">Kiểm Tra Đầy Đủ</a>
        </div>
    </div>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Socket.IO -->
    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Khởi tạo dữ liệu
            let logData = {
                system: [
                    getTimeString() + " Hệ thống khởi động",
                    getTimeString() + " Web server hoạt động",
                    getTimeString() + " Chế độ mô phỏng được kích hoạt",
                    getTimeString() + " Đang thử kết nối Socket.IO..."
                ],
                trading: [
                    getTimeString() + " Không có giao dịch nào được thực hiện",
                    getTimeString() + " Bot giao dịch không hoạt động",
                    getTimeString() + " Đang sử dụng dữ liệu mô phỏng"
                ],
                socket: [
                    getTimeString() + " Đang kiểm tra kết nối Socket.IO..."
                ]
            };
            
            // Cập nhật nhật ký
            showLog('system');
            
            // Sự kiện thay đổi loại nhật ký
            document.getElementById('log-type').addEventListener('change', function() {
                showLog(this.value);
            });
            
            // Nút làm mới
            document.getElementById('refresh-btn').addEventListener('click', function() {
                checkSocketStatus();
                updatePrices();
                updateEnvInfo();
                
                // Thêm nhật ký
                addLog('system', "Đã làm mới trạng thái hệ thống");
                showLog(document.getElementById('log-type').value);
            });
            
            // Nút xóa nhật ký
            document.getElementById('clear-log').addEventListener('click', function() {
                const logType = document.getElementById('log-type').value;
                logData[logType] = [getTimeString() + " Đã xóa nhật ký"];
                showLog(logType);
            });
            
            // Khởi tạo dữ liệu
            checkSocketStatus();
            updatePrices();
            updateEnvInfo();
            
            // Tự động cập nhật giá mỗi 10 giây
            setInterval(updatePrices, 10000);
            
            // Thử kết nối Socket.IO
            function checkSocketStatus() {
                const socketStatusRow = document.getElementById('socket-status-row');
                socketStatusRow.querySelector('td:last-child').innerHTML = '<span class="status-indicator status-offline"></span> Đang kiểm tra...';
                
                addLog('socket', "Đang kiểm tra kết nối Socket.IO...");
                
                try {
                    // Tạo kết nối socket với timeout ngắn
                    const socket = io({
                        transports: ['websocket', 'polling'],
                        reconnectionAttempts: 2,
                        reconnectionDelay: 1000,
                        timeout: 3000
                    });
                    
                    // Đặt thời gian chờ
                    const socketTimeout = setTimeout(() => {
                        socketStatusRow.querySelector('td:last-child').innerHTML = '<span class="status-indicator status-inactive"></span> Không phản hồi';
                        addLog('socket', "Socket.IO không phản hồi - sử dụng chế độ mô phỏng");
                        socket.disconnect();
                    }, 3000);
                    
                    socket.on('connect', function() {
                        clearTimeout(socketTimeout);
                        socketStatusRow.querySelector('td:last-child').innerHTML = '<span class="status-indicator status-active"></span> Hoạt động';
                        addLog('socket', "Kết nối Socket.IO thành công");
                        
                        // Tự động ngắt kết nối sau 5 giây
                        setTimeout(() => {
                            socket.disconnect();
                            addLog('socket', "Đã ngắt kết nối Socket.IO sau khi kiểm tra");
                        }, 5000);
                    });
                    
                    socket.on('connect_error', function(error) {
                        clearTimeout(socketTimeout);
                        socketStatusRow.querySelector('td:last-child').innerHTML = '<span class="status-indicator status-inactive"></span> Lỗi kết nối';
                        addLog('socket', "Lỗi kết nối Socket.IO: " + error.message);
                    });
                    
                } catch (error) {
                    socketStatusRow.querySelector('td:last-child').innerHTML = '<span class="status-indicator status-inactive"></span> Lỗi khởi tạo';
                    addLog('socket', "Lỗi khởi tạo Socket.IO: " + error.message);
                }
            }
            
            // Cập nhật giá
            function updatePrices() {
                document.getElementById('price-update-time').textContent = 'Cập nhật: ' + new Date().toLocaleTimeString();
                
                // BTC
                const btcPrice = 61000 + Math.random() * 1000;
                document.getElementById('btc-price').textContent = btcPrice.toLocaleString(undefined, {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
                
                // ETH
                const ethPrice = 3100 + Math.random() * 100;
                document.getElementById('eth-price').textContent = ethPrice.toLocaleString(undefined, {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
                
                // Thêm nhật ký
                addLog('trading', `Cập nhật giá: BTC = ${btcPrice.toFixed(2)}, ETH = ${ethPrice.toFixed(2)}`);
            }
            
            // Cập nhật thông tin môi trường
            function updateEnvInfo() {
                const envInfo = document.getElementById('env-info');
                
                // Tạo dữ liệu mẫu
                envInfo.innerHTML = `
                    <tr>
                        <td width="200">Flask</td>
                        <td>2.0.1</td>
                    </tr>
                    <tr>
                        <td>Python</td>
                        <td>3.11.4</td>
                    </tr>
                    <tr>
                        <td>Chế độ</td>
                        <td>Mô phỏng</td>
                    </tr>
                    <tr>
                        <td>SocketIO</td>
                        <td>5.3.0</td>
                    </tr>
                    <tr>
                        <td>Chart.js</td>
                        <td>3.9.1</td>
                    </tr>
                `;
                
                // Thêm nhật ký
                addLog('system', "Đã cập nhật thông tin môi trường");
            }
            
            // Thêm nhật ký
            function addLog(type, message) {
                logData[type].push(getTimeString() + " " + message);
                // Giới hạn kích thước nhật ký
                if (logData[type].length > 100) {
                    logData[type] = logData[type].slice(-100);
                }
            }
            
            // Hiển thị nhật ký
            function showLog(type) {
                document.getElementById('log-content').textContent = logData[type].join('\n');
            }
            
            // Lấy chuỗi thời gian
            function getTimeString() {
                return new Date().toLocaleTimeString();
            }
        });
    </script>
</body>
</html>