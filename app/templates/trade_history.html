{% extends "layout.html" %}

{% block title %}Lịch sử giao dịch - Trading Bot{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <div class="row">
    <div class="col-lg-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Lịch sử giao dịch</h2>
        <div>
          <button class="btn btn-sm btn-outline-primary refresh-btn">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-clockwise" viewBox="0 0 16 16">
              <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/>
              <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/>
            </svg>
            Làm mới
          </button>
        </div>
      </div>
      
      <!-- Trading Performance Summary -->
      <div class="card mb-4">
        <div class="card-header bg-primary bg-opacity-10">
          <h4 class="card-title mb-0">Tổng quan hiệu suất</h4>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-9">
              <div class="row">
                <div class="col-md-3">
                  <div class="mb-3">
                    <h6 class="text-muted">Tổng lợi nhuận</h6>
                    <h3 id="total-pnl" class="text-success">+$1,245.50</h3>
                    <span class="small text-success">+12.5%</span>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="mb-3">
                    <h6 class="text-muted">Thắng/Thua</h6>
                    <h3 id="win-loss">18/7</h3>
                    <span class="small text-muted">Tỉ lệ thắng: 72%</span>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="mb-3">
                    <h6 class="text-muted">Tổng giao dịch</h6>
                    <h3 id="total-trades">25</h3>
                    <span class="small text-muted">Trong 30 ngày qua</span>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="mb-3">
                    <h6 class="text-muted">Khối lượng</h6>
                    <h3 id="total-volume">$45,670.25</h3>
                    <span class="small text-success">+5.8% so với tuần trước</span>
                  </div>
                </div>
              </div>
              
              <div class="row mt-3">
                <div class="col-md-3">
                  <div class="mb-3">
                    <h6 class="text-muted">Lợi nhuận trung bình</h6>
                    <h5 id="avg-profit" class="text-success">+$89.25</h5>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="mb-3">
                    <h6 class="text-muted">Lỗ trung bình</h6>
                    <h5 id="avg-loss" class="text-danger">-$45.80</h5>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="mb-3">
                    <h6 class="text-muted">Lợi/Lỗ tốt nhất</h6>
                    <h5 id="best-trade" class="text-success">+$320.50</h5>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="mb-3">
                    <h6 class="text-muted">Lợi/Lỗ tệ nhất</h6>
                    <h5 id="worst-trade" class="text-danger">-$175.25</h5>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="col-md-3">
              <h6 class="text-muted mb-3">Phân bố lợi nhuận theo cặp</h6>
              <div class="mb-2">
                <div class="d-flex justify-content-between mb-1">
                  <span>BTC/USDT</span>
                  <span class="text-success">+$780.25</span>
                </div>
                <div class="progress" style="height: 8px;">
                  <div class="progress-bar bg-success" role="progressbar" style="width: 62%;" aria-valuenow="62" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
              </div>
              <div class="mb-2">
                <div class="d-flex justify-content-between mb-1">
                  <span>ETH/USDT</span>
                  <span class="text-success">+$355.00</span>
                </div>
                <div class="progress" style="height: 8px;">
                  <div class="progress-bar bg-success" role="progressbar" style="width: 28%;" aria-valuenow="28" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
              </div>
              <div class="mb-2">
                <div class="d-flex justify-content-between mb-1">
                  <span>SOL/USDT</span>
                  <span class="text-success">+$175.50</span>
                </div>
                <div class="progress" style="height: 8px;">
                  <div class="progress-bar bg-success" role="progressbar" style="width: 14%;" aria-valuenow="14" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
              </div>
              <div class="mb-2">
                <div class="d-flex justify-content-between mb-1">
                  <span>XRP/USDT</span>
                  <span class="text-danger">-$65.25</span>
                </div>
                <div class="progress" style="height: 8px;">
                  <div class="progress-bar bg-danger" role="progressbar" style="width: 5%;" aria-valuenow="5" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Performance Chart -->
      <div class="card mb-4">
        <div class="card-header bg-primary bg-opacity-10">
          <div class="d-flex justify-content-between align-items-center">
            <h4 class="card-title mb-0">Biểu đồ hiệu suất</h4>
            <div>
              <div class="btn-group" role="group" aria-label="Timeframe selection">
                <button type="button" class="btn btn-sm btn-outline-primary" data-timeframe="7d">7D</button>
                <button type="button" class="btn btn-sm btn-outline-primary active" data-timeframe="30d">30D</button>
                <button type="button" class="btn btn-sm btn-outline-primary" data-timeframe="3m">3M</button>
                <button type="button" class="btn btn-sm btn-outline-primary" data-timeframe="all">Tất cả</button>
              </div>
            </div>
          </div>
        </div>
        <div class="card-body">
          <div id="performance-chart" style="height: 300px;"></div>
        </div>
      </div>
      
      <!-- Trade History Filters -->
      <div class="card mb-4">
        <div class="card-header bg-primary bg-opacity-10">
          <h4 class="card-title mb-0">Bộ lọc</h4>
        </div>
        <div class="card-body">
          <form id="filter-form" class="row g-3">
            <div class="col-md-2">
              <label for="filter-symbol" class="form-label">Biểu tượng</label>
              <select class="form-select" id="filter-symbol">
                <option value="">Tất cả</option>
                <option value="BTCUSDT">BTC/USDT</option>
                <option value="ETHUSDT">ETH/USDT</option>
                <option value="SOLUSDT">SOL/USDT</option>
                <option value="XRPUSDT">XRP/USDT</option>
              </select>
            </div>
            <div class="col-md-2">
              <label for="filter-side" class="form-label">Chiều</label>
              <select class="form-select" id="filter-side">
                <option value="">Tất cả</option>
                <option value="BUY">Mua</option>
                <option value="SELL">Bán</option>
              </select>
            </div>
            <div class="col-md-2">
              <label for="filter-strategy" class="form-label">Chiến lược</label>
              <select class="form-select" id="filter-strategy">
                <option value="">Tất cả</option>
                <option value="RSI">RSI</option>
                <option value="MACD">MACD</option>
                <option value="BB">Bollinger Bands</option>
                <option value="EMA">EMA Cross</option>
                <option value="MANUAL">Thủ công</option>
              </select>
            </div>
            <div class="col-md-2">
              <label for="filter-result" class="form-label">Kết quả</label>
              <select class="form-select" id="filter-result">
                <option value="">Tất cả</option>
                <option value="WIN">Thắng</option>
                <option value="LOSS">Thua</option>
              </select>
            </div>
            <div class="col-md-2">
              <label for="filter-date-from" class="form-label">Từ ngày</label>
              <input type="date" class="form-control" id="filter-date-from">
            </div>
            <div class="col-md-2">
              <label for="filter-date-to" class="form-label">Đến ngày</label>
              <input type="date" class="form-control" id="filter-date-to">
            </div>
            <div class="col-12 text-end">
              <button type="reset" class="btn btn-outline-secondary">Đặt lại</button>
              <button type="submit" class="btn btn-primary">Áp dụng</button>
            </div>
          </form>
        </div>
      </div>
      
      <!-- Trade History Table -->
      <div class="card mb-4">
        <div class="card-header bg-primary bg-opacity-10">
          <div class="d-flex justify-content-between align-items-center">
            <h4 class="card-title mb-0">Lịch sử giao dịch</h4>
            <div class="btn-group">
              <button type="button" class="btn btn-sm btn-outline-primary" id="export-csv">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-file-earmark-spreadsheet" viewBox="0 0 16 16">
                  <path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2zM9.5 3A1.5 1.5 0 0 0 11 4.5h2V9H3V2a1 1 0 0 1 1-1h5.5v2zM3 12v-2h2v2H3zm0 1h2v2H4a1 1 0 0 1-1-1v-1zm3 2v-2h3v2H6zm4 0v-2h3v1a1 1 0 0 1-1 1h-2zm3-3h-3v-2h3v2zm-7 0v-2h3v2H6z"/>
                </svg>
                Xuất CSV
              </button>
            </div>
          </div>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-striped table-hover align-middle" id="trade-history-table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Ngày giờ</th>
                  <th>Biểu tượng</th>
                  <th>Chiều</th>
                  <th>Chiến lược</th>
                  <th>Giá vào</th>
                  <th>Giá ra</th>
                  <th>Khối lượng</th>
                  <th>PnL</th>
                  <th>ROI %</th>
                  <th>Thời gian</th>
                  <th>Trạng thái</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td><small class="text-muted">#12345</small></td>
                  <td>28/02/2025 10:15</td>
                  <td>BTC/USDT</td>
                  <td><span class="badge bg-success">LONG</span></td>
                  <td><span class="badge bg-info">RSI</span></td>
                  <td>$79,250.00</td>
                  <td>$79,850.00</td>
                  <td>0.1 BTC</td>
                  <td class="text-success">+$60.00</td>
                  <td class="text-success">+0.76%</td>
                  <td>2h 34m</td>
                  <td><span class="badge bg-success">THẮNG</span></td>
                </tr>
                <tr>
                  <td><small class="text-muted">#12344</small></td>
                  <td>28/02/2025 08:20</td>
                  <td>ETH/USDT</td>
                  <td><span class="badge bg-danger">SHORT</span></td>
                  <td><span class="badge bg-info">MACD</span></td>
                  <td>$4,210.00</td>
                  <td>$4,150.00</td>
                  <td>1.5 ETH</td>
                  <td class="text-success">+$90.00</td>
                  <td class="text-success">+1.42%</td>
                  <td>4h 15m</td>
                  <td><span class="badge bg-success">THẮNG</span></td>
                </tr>
                <tr>
                  <td><small class="text-muted">#12343</small></td>
                  <td>27/02/2025 22:05</td>
                  <td>SOL/USDT</td>
                  <td><span class="badge bg-success">LONG</span></td>
                  <td><span class="badge bg-info">EMA</span></td>
                  <td>$110.50</td>
                  <td>$108.75</td>
                  <td>10 SOL</td>
                  <td class="text-danger">-$17.50</td>
                  <td class="text-danger">-1.58%</td>
                  <td>3h 22m</td>
                  <td><span class="badge bg-danger">THUA</span></td>
                </tr>
                <tr>
                  <td><small class="text-muted">#12342</small></td>
                  <td>27/02/2025 15:40</td>
                  <td>BTC/USDT</td>
                  <td><span class="badge bg-success">LONG</span></td>
                  <td><span class="badge bg-info">BB</span></td>
                  <td>$78,500.00</td>
                  <td>$79,200.00</td>
                  <td>0.05 BTC</td>
                  <td class="text-success">+$35.00</td>
                  <td class="text-success">+0.89%</td>
                  <td>5h 50m</td>
                  <td><span class="badge bg-success">THẮNG</span></td>
                </tr>
                <tr>
                  <td><small class="text-muted">#12341</small></td>
                  <td>27/02/2025 12:15</td>
                  <td>ETH/USDT</td>
                  <td><span class="badge bg-success">LONG</span></td>
                  <td><span class="badge bg-info">RSI</span></td>
                  <td>$4,050.00</td>
                  <td>$4,105.00</td>
                  <td>1.0 ETH</td>
                  <td class="text-success">+$55.00</td>
                  <td class="text-success">+1.36%</td>
                  <td>2h 10m</td>
                  <td><span class="badge bg-success">THẮNG</span></td>
                </tr>
              </tbody>
            </table>
          </div>
          
          <nav aria-label="Trade history pagination">
            <ul class="pagination justify-content-center mt-4">
              <li class="page-item disabled">
                <a class="page-link" href="#" tabindex="-1" aria-disabled="true">Trước</a>
              </li>
              <li class="page-item active"><a class="page-link" href="#">1</a></li>
              <li class="page-item"><a class="page-link" href="#">2</a></li>
              <li class="page-item"><a class="page-link" href="#">3</a></li>
              <li class="page-item">
                <a class="page-link" href="#">Sau</a>
              </li>
            </ul>
          </nav>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Performance chart
    const performanceCtx = document.getElementById('performance-chart').getContext('2d');
    
    // Sample data
    const dates = [];
    const equity = [];
    const now = new Date();
    
    // Generate sample data - past 30 days
    let currentEquity = 10000; // Starting equity
    for (let i = 30; i >= 0; i--) {
      const date = new Date(now.getTime() - (i * 24 * 60 * 60 * 1000));
      dates.push(date.toLocaleDateString([], {month: 'short', day: 'numeric'}));
      
      // Random change in equity with slight upward trend
      const change = (Math.random() * 200) - 80; // -80 to +120
      currentEquity += change;
      equity.push(currentEquity);
    }
    
    const performanceChart = new Chart(performanceCtx, {
      type: 'line',
      data: {
        labels: dates,
        datasets: [{
          label: 'Account Equity',
          data: equity,
          borderColor: '#28a745',
          backgroundColor: 'rgba(40, 167, 69, 0.1)',
          borderWidth: 2,
          fill: true,
          tension: 0.3
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: true
          },
          tooltip: {
            mode: 'index',
            intersect: false,
            callbacks: {
              label: function(context) {
                return `$${context.parsed.y.toFixed(2)}`;
              }
            }
          }
        },
        scales: {
          x: {
            grid: {
              display: false
            }
          },
          y: {
            grid: {
              color: 'rgba(0, 0, 0, 0.05)'
            },
            ticks: {
              callback: function(value) {
                return '$' + value.toLocaleString();
              }
            }
          }
        }
      }
    });
    
    // Event listeners
    
    // Timeframe buttons
    document.querySelectorAll('[data-timeframe]').forEach(button => {
      button.addEventListener('click', function() {
        // Remove active class from all buttons
        document.querySelectorAll('[data-timeframe]').forEach(btn => {
          btn.classList.remove('active');
        });
        
        // Add active class to clicked button
        this.classList.add('active');
        
        // Get timeframe
        const timeframe = this.getAttribute('data-timeframe');
        
        // In a real app, this would fetch data for the selected timeframe
        // For this demo, we just show different number of days
        let numDays;
        switch (timeframe) {
          case '7d':
            numDays = 7;
            break;
          case '30d':
            numDays = 30;
            break;
          case '3m':
            numDays = 90;
            break;
          case 'all':
            numDays = equity.length - 1;
            break;
          default:
            numDays = 30;
        }
        
        // Update chart with subset of data
        performanceChart.data.labels = dates.slice(-numDays - 1);
        performanceChart.data.datasets[0].data = equity.slice(-numDays - 1);
        performanceChart.update();
      });
    });
    
    // Filter form
    document.getElementById('filter-form').addEventListener('submit', function(e) {
      e.preventDefault();
      
      // Get filter values
      const symbol = document.getElementById('filter-symbol').value;
      const side = document.getElementById('filter-side').value;
      const strategy = document.getElementById('filter-strategy').value;
      const result = document.getElementById('filter-result').value;
      const dateFrom = document.getElementById('filter-date-from').value;
      const dateTo = document.getElementById('filter-date-to').value;
      
      // In a real app, this would filter the trades
      console.log('Filtering trades:', { symbol, side, strategy, result, dateFrom, dateTo });
      
      // For this demo, we just show a message
      showToast('Đã áp dụng bộ lọc', 'success');
    });
    
    // Export CSV button
    document.getElementById('export-csv').addEventListener('click', function() {
      // In a real app, this would export the trades to CSV
      showToast('Đang xuất dữ liệu ra CSV...', 'info');
      
      // For demo, simulate download after a short delay
      setTimeout(() => {
        showToast('Đã xuất thành công', 'success');
      }, 1500);
    });
    
    // Refresh button
    document.querySelector('.refresh-btn').addEventListener('click', function() {
      // In a real app, this would refresh the data
      showToast('Đang tải lại dữ liệu...', 'info');
      
      // For demo, simulate refresh after a short delay
      setTimeout(() => {
        showToast('Đã tải lại dữ liệu thành công', 'success');
      }, 1000);
    });
    
    // Helper function to show toast notifications
    function showToast(message, type = 'primary') {
      const toastContainer = document.getElementById('toast-container');
      const toastId = 'toast-' + Date.now();
      
      const toastHtml = `
        <div id="${toastId}" class="toast bg-${type} text-white" role="alert" aria-live="assertive" aria-atomic="true">
          <div class="d-flex">
            <div class="toast-body">
              ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
          </div>
        </div>
      `;
      
      toastContainer.insertAdjacentHTML('beforeend', toastHtml);
      const toastElement = document.getElementById(toastId);
      const toast = new bootstrap.Toast(toastElement, { autohide: true, delay: 3000 });
      toast.show();
      
      // Remove toast from DOM after it's hidden
      toastElement.addEventListener('hidden.bs.toast', function() {
        this.remove();
      });
    }
  });
</script>
{% endblock %}