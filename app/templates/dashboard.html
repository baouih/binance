{% extends "layout.html" %}

{% block title %}Trading Bot - Dashboard{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
  <div class="row">
    <!-- Market Overview -->
    <div class="col-lg-4">
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0">Market Overview</h5>
        </div>
        <div class="card-body">
          <div class="row mb-3">
            <div class="col">
              <select id="symbol-selector" class="form-select">
                <!-- Will be populated with available symbols -->
              </select>
            </div>
            <div class="col">
              <select id="timeframe-selector" class="form-select">
                <!-- Will be populated with available timeframes -->
              </select>
            </div>
          </div>
          
          <div class="current-price mb-3">
            <h2 id="current-price">0.00</h2>
            <div class="d-flex justify-content-between">
              <div>
                <span class="text-secondary small">24h High</span>
                <div id="price-high">0.00</div>
              </div>
              <div>
                <span class="text-secondary small">24h Low</span>
                <div id="price-low">0.00</div>
              </div>
            </div>
          </div>
          
          <div class="price-chart mb-3">
            <div id="price-chart" style="height: 200px;"></div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Technical Indicators -->
    <div class="col-lg-8">
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0">Technical Indicators</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-4">
              <div class="card indicator-card mb-3">
                <div class="card-body text-center">
                  <h5 class="indicator-title">RSI</h5>
                  <div id="rsi-value" class="indicator-value">50.00</div>
                  <div id="rsi-signal" class="indicator-signal">Neutral</div>
                </div>
              </div>
            </div>
            
            <div class="col-md-4">
              <div class="card indicator-card mb-3">
                <div class="card-body text-center">
                  <h5 class="indicator-title">MACD</h5>
                  <div id="macd-value" class="indicator-value">0.00</div>
                  <div id="macd-signal" class="indicator-signal">Neutral</div>
                </div>
              </div>
            </div>
            
            <div class="col-md-4">
              <div class="card indicator-card mb-3">
                <div class="card-body text-center">
                  <h5 class="indicator-title">EMA Cross</h5>
                  <div id="ema-value" class="indicator-value">0.00%</div>
                  <div id="ema-signal" class="indicator-signal">Neutral</div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-6">
              <div id="rsi-chart" style="height: 200px;"></div>
            </div>
            
            <div class="col-md-6">
              <div id="macd-chart" style="height: 200px;"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="row">
    <!-- Trading Interface -->
    <div class="col-lg-4">
      <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Trading Signal</h5>
          <span id="connection-status" class="badge bg-danger">Disconnected</span>
        </div>
        <div class="card-body">
          <div class="current-signal mb-4">
            <div class="row">
              <div class="col-7">
                <div class="signal-label">Current Signal</div>
                <div id="current-signal" class="signal-value neutral">NEUTRAL</div>
                <div id="signal-probability" class="signal-probability">50.0%</div>
              </div>
              <div class="col-5 text-end">
                <div class="signal-label">Volume</div>
                <div id="volume-value" class="signal-volume">0.00</div>
                <div id="volume-ratio" class="volume-ratio">0.0x</div>
              </div>
            </div>
            <div class="row mt-2">
              <div class="col">
                <div class="signal-label">BB Width</div>
                <div id="bb-width" class="signal-value">0.00%</div>
              </div>
            </div>
          </div>
          
          <div class="place-order mb-4">
            <h6>Place Order</h6>
            <div class="row">
              <div class="col-12 mb-2">
                <label class="form-label small">Quantity</label>
                <input type="number" id="order-quantity" class="form-control" value="0.001" min="0.001" step="0.001">
              </div>
              <div class="col-12">
                <div class="d-flex">
                  <button id="buy-btn" class="btn btn-success flex-grow-1 me-2">BUY</button>
                  <button id="sell-btn" class="btn btn-danger flex-grow-1">SELL</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0">Open Positions</h5>
        </div>
        <div class="card-body">
          <div id="positions-container">
            <div class="alert alert-info">
              <p class="mb-0">No open positions</p>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Active Trading Bots -->
    <div class="col-lg-4">
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0">Active Trading Bots</h5>
        </div>
        <div class="card-body">
          <div id="bots-container">
            <div class="alert alert-info">
              <p class="mb-0">No active bots. Create a bot to start trading.</p>
            </div>
          </div>
          
          <div class="create-bot mt-3">
            <h6>Create New Bot</h6>
            <div class="row">
              <div class="col-12 mb-2">
                <label class="form-label small">Strategy</label>
                <select id="bot-strategy" class="form-select">
                  <!-- Will be populated with strategies -->
                </select>
              </div>
              
              <div id="strategy-params">
                <div class="row" id="rsi-params">
                  <div class="col-6 mb-2">
                    <label class="form-label small">Overbought</label>
                    <input type="number" id="rsi-overbought" class="form-control" value="70" min="50" max="90">
                  </div>
                  <div class="col-6 mb-2">
                    <label class="form-label small">Oversold</label>
                    <input type="number" id="rsi-oversold" class="form-control" value="30" min="10" max="50">
                  </div>
                </div>
              </div>
              
              <div class="col-12">
                <button id="create-bot-btn" class="btn btn-primary">Create Bot</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Performance Metrics -->
    <div class="col-lg-4">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">Performance Metrics</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-6 mb-3">
              <div class="metric-label">Win Rate</div>
              <div id="win-rate" class="metric-value">0.0%</div>
            </div>
            <div class="col-6 mb-3">
              <div class="metric-label">Total Trades</div>
              <div id="total-trades" class="metric-value">0</div>
            </div>
            <div class="col-6 mb-3">
              <div class="metric-label">Profit/Loss</div>
              <div id="total-pnl" class="metric-value">0.0%</div>
            </div>
            <div class="col-6 mb-3">
              <div class="metric-label">Max Drawdown</div>
              <div id="max-drawdown" class="metric-value">0.0%</div>
            </div>
          </div>
          
          <h6 class="mt-3">Trade History</h6>
          <div id="trade-history-container">
            <div class="alert alert-info">
              <p class="mb-0">No trading history available.</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Loading Overlay -->
<div id="page-loader" class="spinner-container" style="display: none;">
  <div class="spinner-border text-light" role="status">
    <span class="visually-hidden">Loading...</span>
  </div>
</div>

<!-- Toast Container for Notifications -->
<div id="toast-container" class="position-fixed bottom-0 end-0 p-3" style="z-index: 5"></div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{{ url_for('static', filename='js/charts.js') }}"></script>
<script src="{{ url_for('static', filename='js/trader.js') }}"></script>
<script src="{{ url_for('static', filename='js/socket.js') }}"></script>
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
<script>
  // Initialize socket client globally
  let socketClient;
  
  document.addEventListener('DOMContentLoaded', function() {
    // Create and initialize the socket
    socketClient = new SocketClient();
    socketClient.init();
    window.socketClient = socketClient;
    
    // Initialize the dashboard controller
    const dashboard = new DashboardController();
    dashboard.init();
    
    // Show notification for simulation mode
    const toastContainer = document.getElementById('toast-container');
    if (toastContainer) {
      const toast = document.createElement('div');
      toast.className = 'toast show';
      toast.setAttribute('role', 'alert');
      toast.setAttribute('aria-live', 'assertive');
      toast.setAttribute('aria-atomic', 'true');
      toast.innerHTML = `
        <div class="toast-header bg-warning text-dark">
          <strong class="me-auto">Simulation Mode</strong>
          <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body">
          The trading bot is running in simulation mode. No real trades will be executed.
        </div>
      `;
      toastContainer.appendChild(toast);
      
      // Auto-dismiss after 5 seconds
      setTimeout(() => {
        const bsToast = new bootstrap.Toast(toast);
        bsToast.hide();
      }, 5000);
    }
  });
</script>
{% endblock %}