{% extends "layout.html" %}

{% block title %}Trading Bot - Backtesting{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="row">
    <div class="col-lg-4">
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0">Backtest Configuration</h5>
        </div>
        <div class="card-body">
          <form id="backtest-form">
            <div class="mb-3">
              <label for="backtest-symbol" class="form-label">Symbol</label>
              <select id="backtest-symbol" class="form-select">
                <option value="BTCUSDT" selected>BTCUSDT</option>
                <option value="ETHUSDT">ETHUSDT</option>
                <option value="BNBUSDT">BNBUSDT</option>
                <option value="ADAUSDT">ADAUSDT</option>
                <option value="DOGEUSDT">DOGEUSDT</option>
                <option value="XRPUSDT">XRPUSDT</option>
              </select>
            </div>
            
            <div class="mb-3">
              <label for="backtest-interval" class="form-label">Timeframe</label>
              <select id="backtest-interval" class="form-select">
                <option value="1m">1 minute</option>
                <option value="5m">5 minutes</option>
                <option value="15m">15 minutes</option>
                <option value="1h" selected>1 hour</option>
                <option value="4h">4 hours</option>
                <option value="1d">1 day</option>
              </select>
            </div>
            
            <div class="mb-3">
              <label for="backtest-strategy" class="form-label">Strategy</label>
              <select id="backtest-strategy" class="form-select">
                <option value="rsi" selected>RSI Strategy</option>
                <option value="macd">MACD Strategy</option>
                <option value="ema_cross">EMA Cross Strategy</option>
                <option value="bbands">Bollinger Bands Strategy</option>
                <option value="ml">ML Strategy</option>
              </select>
            </div>
            
            <div class="mb-3">
              <label for="backtest-lookback" class="form-label">Lookback Period (days)</label>
              <input type="number" id="backtest-lookback" class="form-control" value="30" min="1" max="365">
            </div>
            
            <div class="mb-3">
              <label for="backtest-initial-balance" class="form-label">Initial Balance (USDT)</label>
              <input type="number" id="backtest-initial-balance" class="form-control" value="10000" min="100">
            </div>
            
            <!-- Strategy Specific Parameters -->
            <div id="backtest-strategy-params">
              <!-- RSI Strategy Parameters -->
              <div id="backtest-rsi-params" class="strategy-params mb-3">
                <h6 class="form-label">RSI Parameters</h6>
                <div class="row g-2">
                  <div class="col-6">
                    <label for="backtest-rsi-overbought" class="form-label small">Overbought</label>
                    <input type="number" id="backtest-rsi-overbought" class="form-control" value="70" min="50" max="90">
                  </div>
                  <div class="col-6">
                    <label for="backtest-rsi-oversold" class="form-label small">Oversold</label>
                    <input type="number" id="backtest-rsi-oversold" class="form-control" value="30" min="10" max="50">
                  </div>
                </div>
              </div>
              
              <!-- MACD Strategy Parameters -->
              <div id="backtest-macd-params" class="strategy-params mb-3" style="display: none;">
                <h6 class="form-label">MACD Parameters</h6>
                <p class="small text-secondary">Using default settings (12, 26, 9)</p>
              </div>
              
              <!-- EMA Cross Strategy Parameters -->
              <div id="backtest-ema-params" class="strategy-params mb-3" style="display: none;">
                <h6 class="form-label">EMA Cross Parameters</h6>
                <div class="row g-2">
                  <div class="col-6">
                    <label for="backtest-ema-short" class="form-label small">Short EMA</label>
                    <input type="number" id="backtest-ema-short" class="form-control" value="9" min="5" max="50">
                  </div>
                  <div class="col-6">
                    <label for="backtest-ema-long" class="form-label small">Long EMA</label>
                    <input type="number" id="backtest-ema-long" class="form-control" value="21" min="10" max="200">
                  </div>
                </div>
              </div>
              
              <!-- Bollinger Bands Strategy Parameters -->
              <div id="backtest-bb-params" class="strategy-params mb-3" style="display: none;">
                <h6 class="form-label">Bollinger Bands Parameters</h6>
                <div class="row g-2">
                  <div class="col-12">
                    <label for="backtest-bb-std" class="form-label small">Standard Deviation</label>
                    <input type="number" id="backtest-bb-std" class="form-control" value="2.0" min="1.0" max="3.0" step="0.1">
                  </div>
                </div>
              </div>
              
              <!-- ML Strategy Parameters -->
              <div id="backtest-ml-params" class="strategy-params mb-3" style="display: none;">
                <h6 class="form-label">ML Strategy Parameters</h6>
                <div class="row g-2">
                  <div class="col-12">
                    <label for="backtest-ml-threshold" class="form-label small">Probability Threshold</label>
                    <input type="number" id="backtest-ml-threshold" class="form-control" value="0.65" min="0.5" max="0.9" step="0.05">
                  </div>
                </div>
              </div>
            </div>
            
            <div class="mb-3">
              <label class="form-label">Risk Management</label>
              <div class="row g-2">
                <div class="col-6">
                  <div class="input-group">
                    <span class="input-group-text">Take Profit</span>
                    <input type="number" id="backtest-take-profit" class="form-control" value="5" min="1" max="100">
                    <span class="input-group-text">%</span>
                  </div>
                </div>
                <div class="col-6">
                  <div class="input-group">
                    <span class="input-group-text">Stop Loss</span>
                    <input type="number" id="backtest-stop-loss" class="form-control" value="3" min="1" max="50">
                    <span class="input-group-text">%</span>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="d-grid">
              <button type="button" id="run-backtest-btn" class="btn btn-primary">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-play-fill me-2" viewBox="0 0 16 16">
                  <path d="m11.596 8.697-6.363 3.692c-.54.313-1.233-.066-1.233-.697V4.308c0-.63.692-1.01 1.233-.696l6.363 3.692a.802.802 0 0 1 0 1.393z"/>
                </svg>
                Run Backtest
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
    
    <div class="col-lg-8">
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0">Backtest Results</h5>
        </div>
        <div class="card-body p-0">
          <div id="backtest-results-container" class="p-3">
            <div class="alert alert-info">
              <p>Run a backtest to see results here.</p>
              <p class="mb-0 small">Backtesting allows you to evaluate trading strategies on historical market data without risking real capital.</p>
            </div>
          </div>
        </div>
      </div>
      
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">Previous Backtests</h5>
        </div>
        <div class="card-body">
          <div id="previous-backtests-container">
            <div class="alert alert-secondary">
              <p class="mb-0">No backtest history available.</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Loading Overlay -->
<div id="page-loader" class="spinner-container" style="display: none;">
  <div class="spinner-border text-light" role="status">
    <span class="visually-hidden">Loading...</span>
  </div>
</div>

<!-- Toast Container for Notifications -->
<div id="toast-container" class="position-fixed bottom-0 end-0 p-3" style="z-index: 5"></div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>
<script src="{{ url_for('static', filename='js/charts.js') }}"></script>
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Strategy selector change event
    const strategySelector = document.getElementById('backtest-strategy');
    strategySelector.addEventListener('change', function() {
      // Hide all strategy parameters
      document.querySelectorAll('.strategy-params').forEach(el => {
        el.style.display = 'none';
      });
      
      // Show selected strategy parameters
      const selectedStrategy = strategySelector.value;
      const paramsDiv = document.getElementById(`backtest-${selectedStrategy}-params`);
      if (paramsDiv) {
        paramsDiv.style.display = 'block';
      }
    });
    
    // Run Backtest button click event
    const runBacktestBtn = document.getElementById('run-backtest-btn');
    runBacktestBtn.addEventListener('click', async function() {
      // Show loading spinner
      const loader = document.getElementById('page-loader');
      if (loader) {
        loader.style.display = 'flex';
      }
      
      try {
        // Get backtest parameters
        const symbol = document.getElementById('backtest-symbol').value;
        const interval = document.getElementById('backtest-interval').value;
        const strategy = document.getElementById('backtest-strategy').value;
        const lookbackDays = parseInt(document.getElementById('backtest-lookback').value || 30);
        const initialBalance = parseFloat(document.getElementById('backtest-initial-balance').value || 10000);
        const takeProfit = parseFloat(document.getElementById('backtest-take-profit').value || 5) / 100;
        const stopLoss = parseFloat(document.getElementById('backtest-stop-loss').value || 3) / 100;
        
        // Get strategy-specific parameters
        let params = {};
        
        if (strategy === 'rsi') {
          params = {
            overbought: parseFloat(document.getElementById('backtest-rsi-overbought').value || 70),
            oversold: parseFloat(document.getElementById('backtest-rsi-oversold').value || 30)
          };
        } else if (strategy === 'ema_cross') {
          params = {
            short_period: parseInt(document.getElementById('backtest-ema-short').value || 9),
            long_period: parseInt(document.getElementById('backtest-ema-long').value || 21)
          };
        } else if (strategy === 'bbands') {
          params = {
            deviation_multiplier: parseFloat(document.getElementById('backtest-bb-std').value || 2.0)
          };
        } else if (strategy === 'ml') {
          params = {
            probability_threshold: parseFloat(document.getElementById('backtest-ml-threshold').value || 0.65)
          };
        }
        
        // Create backtest request
        const backtestData = {
          symbol: symbol,
          interval: interval,
          strategy: strategy,
          params: params,
          lookback_days: lookbackDays,
          initial_balance: initialBalance,
          take_profit: takeProfit,
          stop_loss: stopLoss
        };
        
        const response = await fetch('/api/run_backtest', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(backtestData)
        });
        
        const result = await response.json();
        
        if (result.backtest_id) {
          // Show success message
          showToast('Backtest completed successfully', 'success');
          
          // Display backtest results
          displayBacktestResults(result);
          
          // Update backtest history
          loadBacktestHistory();
        } else {
          showToast(result.error || 'Failed to run backtest', 'danger');
        }
      } catch (error) {
        console.error('Error running backtest:', error);
        showToast('Failed to run backtest', 'danger');
      } finally {
        // Hide loading spinner
        if (loader) {
          loader.style.display = 'none';
        }
      }
    });
    
    // Load backtest history on page load
    loadBacktestHistory();
    
    // Function to load backtest history
    async function loadBacktestHistory() {
      try {
        const response = await fetch('/api/backtest_results');
        const results = await response.json();
        
        const container = document.getElementById('previous-backtests-container');
        if (!container) return;
        
        if (results.length === 0) {
          container.innerHTML = `
            <div class="alert alert-secondary">
              <p class="mb-0">No backtest history available.</p>
            </div>
          `;
          return;
        }
        
        // Create a list of backtest results
        const list = document.createElement('div');
        list.className = 'list-group';
        
        results.slice(0, 5).forEach(result => {
          const item = document.createElement('button');
          item.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
          item.setAttribute('data-backtest-id', result.id);
          
          const profitPct = result.metrics.profit_pct * 100;
          const profitClass = profitPct >= 0 ? 'text-success' : 'text-danger';
          
          item.innerHTML = `
            <div>
              <h6 class="mb-1">${result.symbol} (${result.strategy})</h6>
              <small>Created: ${new Date(result.timestamp).toLocaleString()}</small>
            </div>
            <div class="text-end">
              <span class="badge ${profitPct >= 0 ? 'bg-success' : 'bg-danger'}">${profitPct.toFixed(2)}%</span>
              <div><small>${result.metrics.total_trades} trades</small></div>
            </div>
          `;
          
          item.addEventListener('click', () => {
            displayBacktestResults(result);
          });
          
          list.appendChild(item);
        });
        
        container.innerHTML = '';
        container.appendChild(list);
        
        if (results.length > 5) {
          const moreText = document.createElement('p');
          moreText.className = 'mt-2 text-center text-secondary small';
          moreText.textContent = `Showing 5 of ${results.length} backtest results`;
          container.appendChild(moreText);
        }
      } catch (error) {
        console.error('Error loading backtest history:', error);
      }
    }
    
    // Function to display backtest results
    function displayBacktestResults(results) {
      // Get the container
      const resultsContainer = document.getElementById('backtest-results-container');
      if (!resultsContainer) return;
      
      // Clear the container
      resultsContainer.innerHTML = '';
      
      // Create results card
      const card = document.createElement('div');
      card.className = 'backtest-result';
      
      // Format metrics
      const metrics = results.metrics;
      const totalTrades = metrics.total_trades;
      const winRate = (metrics.win_rate * 100).toFixed(2) + '%';
      const profitPercent = (metrics.profit_pct * 100).toFixed(2) + '%';
      const profitAmount = metrics.profit_amount.toFixed(2);
      const maxDrawdown = (metrics.max_drawdown * 100).toFixed(2) + '%';
      const sharpeRatio = metrics.sharpe_ratio ? metrics.sharpe_ratio.toFixed(2) : 'N/A';
      
      card.innerHTML = `
        <div class="d-flex justify-content-between align-items-center mb-3">
          <div>
            <h5 class="mb-0">Results: ${results.symbol} (${results.strategy})</h5>
            <small class="text-secondary">Period: ${new Date(results.results[0].date).toLocaleDateString()} to ${new Date(results.results[results.results.length-1].date).toLocaleDateString()}</small>
          </div>
          <span class="badge ${metrics.profit_pct >= 0 ? 'bg-success' : 'bg-danger'} fs-5">
            ${profitPercent}
          </span>
        </div>
        <div class="row mb-3">
          <div class="col-md-3 col-sm-6 mb-3">
            <div class="card bg-secondary">
              <div class="card-body text-center p-3">
                <h6 class="card-title">Total Trades</h6>
                <p class="metric-value">${totalTrades}</p>
              </div>
            </div>
          </div>
          <div class="col-md-3 col-sm-6 mb-3">
            <div class="card bg-secondary">
              <div class="card-body text-center p-3">
                <h6 class="card-title">Win Rate</h6>
                <p class="metric-value">${winRate}</p>
              </div>
            </div>
          </div>
          <div class="col-md-3 col-sm-6 mb-3">
            <div class="card bg-secondary">
              <div class="card-body text-center p-3">
                <h6 class="card-title">Profit</h6>
                <p class="metric-value ${metrics.profit_pct >= 0 ? 'metric-positive' : 'metric-negative'}">
                  ${profitAmount}
                </p>
              </div>
            </div>
          </div>
          <div class="col-md-3 col-sm-6 mb-3">
            <div class="card bg-secondary">
              <div class="card-body text-center p-3">
                <h6 class="card-title">Max Drawdown</h6>
                <p class="metric-value metric-negative">${maxDrawdown}</p>
              </div>
            </div>
          </div>
        </div>

        <div class="chart-container mb-4">
          <canvas id="backtest-chart-${results.backtest_id}"></canvas>
        </div>
        
        <h6 class="mt-3 mb-2">Trade History</h6>
        <div class="table-responsive">
          <table class="table table-sm">
            <thead>
              <tr>
                <th>Side</th>
                <th>Entry Price</th>
                <th>Exit Price</th>
                <th>Amount</th>
                <th>P&L</th>
                <th>P&L %</th>
              </tr>
            </thead>
            <tbody>
              ${results.trades.slice(0, 10).map(trade => `
                <tr>
                  <td>${trade.side}</td>
                  <td>${parseFloat(trade.entry_price).toFixed(2)}</td>
                  <td>${parseFloat(trade.exit_price).toFixed(2)}</td>
                  <td>${parseFloat(trade.amount).toFixed(2)}</td>
                  <td class="${trade.pnl_amount >= 0 ? 'text-success' : 'text-danger'}">
                    ${parseFloat(trade.pnl_amount).toFixed(2)}
                  </td>
                  <td class="${trade.pnl_pct >= 0 ? 'text-success' : 'text-danger'}">
                    ${(trade.pnl_pct * 100).toFixed(2)}%
                  </td>
                </tr>
              `).join('')}
              ${results.trades.length > 10 ? `
                <tr>
                  <td colspan="6" class="text-center">
                    <em>Showing 10 of ${results.trades.length} trades</em>
                  </td>
                </tr>
              ` : ''}
            </tbody>
          </table>
        </div>
      `;
      
      // Append to container
      resultsContainer.appendChild(card);
      
      // Initialize backtest chart
      setTimeout(() => {
        const charts = new TradingCharts();
        charts.initBacktestChart(`backtest-chart-${results.backtest_id}`, results);
      }, 100);
    }
    
    // Function to show toast notifications
    function showToast(message, type = 'primary') {
      const toastContainer = document.getElementById('toast-container');
      if (!toastContainer) return;
      
      const toast = document.createElement('div');
      toast.className = 'toast show';
      toast.setAttribute('role', 'alert');
      toast.setAttribute('aria-live', 'assertive');
      toast.setAttribute('aria-atomic', 'true');
      
      toast.innerHTML = `
        <div class="toast-header bg-${type} ${type === 'danger' || type === 'dark' ? 'text-white' : ''}">
          <strong class="me-auto">${type.charAt(0).toUpperCase() + type.slice(1)}</strong>
          <button type="button" class="btn-close ${type === 'danger' || type === 'dark' ? 'btn-close-white' : ''}" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body">
          ${message}
        </div>
      `;
      
      toastContainer.appendChild(toast);
      
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => {
          toast.remove();
        }, 500);
      }, 5000);
    }
  });
</script>
{% endblock %}
